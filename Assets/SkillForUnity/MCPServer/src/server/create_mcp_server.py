from __future__ import annotations

from mcp.server import Server

from resources.register_resources import register_resources
from tools.register_tools import register_tools
from version import SERVER_NAME, SERVER_VERSION


def create_mcp_server() -> Server:
    server = Server(
        SERVER_NAME,
        version=SERVER_VERSION,
        instructions="\n".join(
            [
                "# Unity MCP Server - Quick Reference",
                "Unityãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨é€£æºã™ã‚‹MCPã‚µãƒ¼ãƒãƒ¼ã€‚resourcesã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ å‚ç…§ã€toolsã§UnityEditoræ“ä½œã€‚",
                "",
                "## ğŸ”´ Critical Rules (å¿…ãšå®ˆã‚‹)",
                "1. .metaãƒ•ã‚¡ã‚¤ãƒ«ã¯çµ¶å¯¾ã«ç·¨é›†ã—ãªã„ï¼ˆUnityè‡ªå‹•ç®¡ç†ã€æ‰‹å‹•ç·¨é›†ã¯å‚ç…§ç ´å£Šï¼‰",
                "2. å…¨Unityæ“ä½œã«MCPãƒ„ãƒ¼ãƒ«ï¼ˆunity_*ï¼‰ã‚’ä½¿ç”¨",
                "3. å¤‰æ›´å‰ã« operation='inspect' ã§å¯¾è±¡ã‚’ç¢ºèª",
                "4. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å„ªå…ˆæ´»ç”¨ï¼ˆæ‰‹å‹•ä½œæˆã‚ˆã‚Š10å€é«˜é€Ÿï¼‰",
                "",
                "## åŸºæœ¬ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼",
                "1. ç¢ºèª: unity_scene_crud(operation='inspect', includeHierarchy=True) # 1éšå±¤ã®ã¿è¿”ã™",
                "2. æ“ä½œ: å¯¾å¿œãƒ„ãƒ¼ãƒ«ã§å¤‰æ›´å®Ÿæ–½",
                "3. æ¤œè¨¼: operation='inspect' ã§çµæœç¢ºèª",
                "",
                "## Core Operations",
                "",
                "### Scene & GameObject",
                "- ä½œæˆ: unity_gameobject_crud(operation='create', name='...', parentPath='...')",
                "- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: unity_gameobject_createFromTemplate(template='Cube'|'Sphere'|'Camera'|'Light-Directional'|'Empty'|'Player')",
                "- è¤‡æ•°æ¤œç´¢: unity_gameobject_crud(operation='findMultiple', pattern='Enemy*', maxResults=100)",
                "- ç§»å‹•: unity_gameobject_crud(operation='move', gameObjectPath='...', parentPath='...')",
                "- è¤‡é›‘æ§‹é€ : unity_template_manage(operation='customize', gameObjectPath='...', components=[...], children=[...])",
                "",
                "### Component",
                "- è¿½åŠ : unity_component_crud(operation='add', gameObjectPath='...', componentType='UnityEngine.Rigidbody', propertyChanges={...})",
                "- æ›´æ–°: unity_component_crud(operation='update', gameObjectPath='...', componentType='...', propertyChanges={...})",
                "- ã‚¢ã‚»ãƒƒãƒˆå‚ç…§: propertyChanges={'sharedMesh': 'Library/unity default resources::Sphere'} ã¾ãŸã¯ {'_ref': 'asset', 'guid': '...'}",
                "- UnityEvent: propertyChanges={'onClick': 'GameManager.OnButtonClick'} ã¾ãŸã¯ {'onClick': {'listeners': [...]}}",
                "- ãƒãƒƒãƒè¿½åŠ : unity_component_crud(operation='addMultiple', pattern='Enemy*', componentType='...', stopOnError=False, maxResults=100)",
                "- ãƒãƒƒãƒæ›´æ–°: operation='updateMultiple'",
                "",
                "### UI (ã‚²ãƒ¼ãƒ é–‹ç™ºã®æœ€åˆã«å®Ÿè£…æ¨å¥¨)",
                "ç†ç”±: å¾Œã‹ã‚‰ã®è¿½åŠ ã¯ä½ç½®èª¿æ•´ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚ŒãŒç™ºç”Ÿã—ã‚„ã™ã„",
                "- ä½œæˆ: unity_ugui_createFromTemplate(template='Button'|'Text'|'Image'|'Panel'|'InputField'|'Slider', name='...', parentPath='Canvas/...', width=..., height=..., text='...')",
                "- ã‚¢ãƒ³ã‚«ãƒ¼: unity_ugui_manage(operation='setAnchorPreset', gameObjectPath='...', preset='middle-center'|'top-left'|'stretch-all', preservePosition=True)",
                "- RectTransformæ›´æ–°: unity_ugui_manage(operation='updateRect', gameObjectPath='...', anchoredPosition={'x': 0, 'y': 0}, sizeDelta={'x': 200, 'y': 60})",
                "- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: unity_ugui_layoutManage(operation='add', gameObjectPath='...', layoutType='VerticalLayoutGroup'|'HorizontalLayoutGroup'|'GridLayoutGroup', spacing=10, padding={...})",
                "- ãƒ¡ãƒ‹ãƒ¥ãƒ¼éšå±¤: unity_menu_hierarchyCreate(menuName='...', menuStructure={...}, generateStateMachine=True, stateMachineScriptPath='...')",
                "",
                "### Asset & Script",
                "- ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: unity_asset_crud(operation='create', assetPath='Assets/Data/config.json', content='...')",
                "- æ›´æ–°: unity_asset_crud(operation='update', assetPath='...', content='...')",
                "- ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼è¨­å®š: unity_asset_crud(operation='updateImporter', assetPath='...', propertyChanges={...})",
                "- ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ: unity_script_template_generate(templateType='MonoBehaviour'|'ScriptableObject', className='...', scriptPath='Assets/Scripts/....cs', namespace='...')",
                "- ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³: unity_designPattern_generate(patternType='singleton'|'objectpool'|'statemachine'|'observer'|'command'|'factory', className='...', scriptPath='...', options={...})",
                "- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¾…æ©Ÿ: unity_await_compilation(timeoutSeconds=60) # å¤‰æ›´ã¾ã¨ã‚ã¦ã‹ã‚‰å®Ÿè¡Œ",
                "",
                "### ScriptableObject",
                "- ä½œæˆ: unity_scriptableObject_crud(operation='create', typeName='MyGame.GameConfig', assetPath='Assets/Data/....asset', properties={...})",
                "- æ¤œæŸ»: unity_scriptableObject_crud(operation='inspect', assetPath='...', includeProperties=True, propertyFilter=['version', 'maxPlayers'])",
                "- æ›´æ–°: unity_scriptableObject_crud(operation='update', assetPath='...', properties={...})",
                "- å‹æ¤œç´¢: unity_scriptableObject_crud(operation='findByType', typeName='...', searchPath='Assets/Data', maxResults=100)",
                "",
                "### Prefab",
                "- ä½œæˆ: unity_prefab_crud(operation='create', gameObjectPath='...', prefabPath='Assets/Prefabs/....prefab', includeChildren=True)",
                "- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–: unity_prefab_crud(operation='instantiate', prefabPath='...', parentPath='...')",
                "- ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰é©ç”¨: unity_prefab_crud(operation='applyOverrides', gameObjectPath='...')",
                "- ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ç ´æ£„: unity_prefab_crud(operation='revertOverrides', gameObjectPath='...')",
                "",
                "### Vector Sprite (ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ç”¨)",
                "å¤–éƒ¨ã‚¢ã‚»ãƒƒãƒˆä¸è¦ã§å³åº§ã«ç”Ÿæˆã€‚ã‚²ãƒ¼ãƒ ã‚¸ãƒ£ãƒ ã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«æœ€é©ã€‚",
                "- ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–: unity_vectorSprite_convert(operation='primitiveToSprite', primitiveType='circle'|'square'|'triangle'|'polygon', color={'r':1,'g':0,'b':0,'a':1}, outputPath='Assets/Sprites/....png', width=256, height=256)",
                "- å˜è‰²: unity_vectorSprite_convert(operation='createColorSprite', width=64, height=64, color={...}, outputPath='...')",
                "- SVGå¤‰æ›: unity_vectorSprite_convert(operation='svgToSprite', svgPath='...', outputPath='...', width=512, height=512)",
                "- ãƒ†ã‚¯ã‚¹ãƒãƒ£â†’ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ: unity_vectorSprite_convert(operation='textureToSprite', texturePath='...', pixelsPerUnit=100, filterMode='point'|'bilinear')",
                "",
                "## âš¡ Performance Optimization (é‡è¦)",
                "",
                "### é«˜é€ŸåŒ–ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯:",
                "1. includeProperties=False: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå­˜åœ¨ç¢ºèªã®ã¿ï¼ˆ10å€é«˜é€Ÿï¼‰",
                "   unity_component_crud(operation='inspect', gameObjectPath='...', componentType='...', includeProperties=False)",
                "2. propertyFilter: å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿å–å¾—",
                "   unity_component_crud(operation='inspect', ..., propertyFilter=['position', 'rotation'])",
                "3. maxResults: å¤§é‡æ“ä½œæ™‚ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆé˜²æ­¢",
                "   unity_gameobject_crud(operation='findMultiple', pattern='*', maxResults=100)",
                "4. stopOnError=False: ãƒãƒƒãƒå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç¶šè¡Œ",
                "   unity_component_crud(operation='addMultiple', pattern='Enemy*', ..., stopOnError=False)",
                "",
                "### ãƒãƒƒãƒæ“ä½œï¼ˆæ¨å¥¨ï¼‰:",
                "*Multipleæ“ä½œã‚’ä½¿ç”¨: addMultiple, updateMultiple, deleteMultiple, inspectMultiple",
                "âŒ é¿ã‘ã‚‹: ãƒ«ãƒ¼ãƒ—å†…ã§å€‹åˆ¥ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—",
                "âœ… æ¨å¥¨: unity_component_crud(operation='addMultiple', pattern='Enemy*', componentType='UnityEngine.Rigidbody', maxResults=100)",
                "",
                "## ğŸ® Game Development Best Practices",
                "",
                "### æ¨å¥¨å®Ÿè£…é †åº:",
                "1. UIå®Ÿè£…ï¼ˆæœ€åˆï¼‰",
                "   - ç†ç”±: å¾Œã‹ã‚‰ã®è¿½åŠ ã¯ä½ç½®èª¿æ•´ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚ŒãŒç™ºç”Ÿã—ã‚„ã™ã„",
                "   - å…¨UIè¦ç´ ã‚’ä½œæˆãƒ»é…ç½®ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ã‚¢ãƒ³ã‚«ãƒ¼è¨­å®šå®Œäº†",
                "   - ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã¯ç©ºã§OK",
                "",
                "2. ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…",
                "   - ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«ã€çŠ¶æ…‹ç®¡ç†ã€ã‚¹ã‚³ã‚¢è¨ˆç®—",
                "   - UIã‚¤ãƒ™ãƒ³ãƒˆã¨ãƒ­ã‚¸ãƒƒã‚¯æ¥ç¶š",
                "   - ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã§å‹•ä½œç¢ºèª",
                "",
                "3. æ¼”å‡ºå®Ÿè£…ï¼ˆæœ€å¾Œï¼‰",
                "   - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚µã‚¦ãƒ³ãƒ‰",
                "   - UIé·ç§»ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¼”å‡º",
                "   - ç†ç”±: å‹•ä½œã«å½±éŸ¿ã›ãšã€ç‹¬ç«‹ã—ã¦èª¿æ•´å¯èƒ½",
                "",
                "### C#ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ«ãƒ¼ãƒ«:",
                "- [SerializeField] privateå¤‰æ•° â†’ publicèª­ã¿å–ã‚Šå°‚ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¿…é ˆ",
                "  ä¾‹: [SerializeField] private int health; â†’ public int Health => health;",
                "- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«: å¤‰æ›´ã¾ã¨ã‚ã¦ã‹ã‚‰ unity_await_compilation ã§ä¸€åº¦å®Ÿè¡Œ",
                "",
                "## ğŸ”§ Troubleshooting",
                "",
                "### æ¥ç¶šã‚¨ãƒ©ãƒ¼",
                "1. unity_ping ã§æ¥ç¶šç¢ºèª",
                "2. Unity Editorã§ Tools > MCP Assistant ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª",
                "",
                "### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼",
                "1. unity_await_compilation(timeoutSeconds=60) ã§è©³ç´°å–å¾—",
                "2. æˆ»ã‚Šå€¤ã® consoleLogs.errors ã‚’ç¢ºèª",
                "3. ã‚¨ãƒ©ãƒ¼ä¿®æ­£å¾Œã€å†åº¦ unity_await_compilation",
                "",
                "### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ",
                "1. maxResults ã‚’æ¸›ã‚‰ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1000ï¼‰",
                "2. includeProperties=False ã§é«˜é€ŸåŒ–",
                "3. stopOnError=False ã§ãƒãƒƒãƒæ“ä½œç¶šè¡Œ",
                "",
                "### æ¥ç¶šåˆ‡æ–­ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ",
                "1. unity_await_compilation ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ç¢ºèª",
                "2. Unity Editorã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ãƒã‚§ãƒƒã‚¯",
                "3. é•·æ™‚é–“æ“ä½œã¯ maxResults ã§åˆ†å‰²å®Ÿè¡Œ",
                "",
                "## Additional Tools",
                "",
                "### Scene Setup",
                "- ã‚¯ã‚¤ãƒƒã‚¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: unity_scene_quickSetup(setupType='3D'|'2D'|'UI'|'VR'|'Empty', cameraPosition={...}, lightIntensity=1.0)",
                "",
                "### Tags & Layers",
                "- ã‚¿ã‚°è¿½åŠ : unity_tagLayer_manage(operation='addTag', tag='...')",
                "- ã‚¿ã‚°è¨­å®š: unity_tagLayer_manage(operation='setTag', gameObjectPath='...', tag='...')",
                "- ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ : unity_tagLayer_manage(operation='addLayer', layer='...')",
                "- ãƒ¬ã‚¤ãƒ¤ãƒ¼å†å¸°è¨­å®š: unity_tagLayer_manage(operation='setLayerRecursive', gameObjectPath='...', layer='...')",
                "",
                "### Project Settings",
                "- èª­ã¿å–ã‚Š: unity_projectSettings_crud(operation='read', category='player'|'quality'|'time'|'physics'|'audio'|'editor', property='...')",
                "- æ›¸ãè¾¼ã¿: unity_projectSettings_crud(operation='write', category='...', property='...', value=...)",
                "",
                "### Constants",
                "- Enumâ†’å€¤: unity_constant_convert(operation='enumToValue', enumType='UnityEngine.KeyCode', enumValue='Space')",
                "- å€¤â†’Enum: unity_constant_convert(operation='valueToEnum', enumType='...', numericValue=32)",
                "- è‰²â†’RGBA: unity_constant_convert(operation='colorToRGBA', colorName='red')",
                "",
                "### Build Settings",
                "- ä¸€è¦§: unity_scene_crud(operation='listBuildSettings')",
                "- è¿½åŠ : unity_scene_crud(operation='addToBuildSettings', scenePath='...', index=1, enabled=True)",
                "- å‰Šé™¤: unity_scene_crud(operation='removeFromBuildSettings', index=0)",
                "- ä¸¦ã¹æ›¿ãˆ: unity_scene_crud(operation='reorderBuildSettings', fromIndex=0, toIndex=2)",
                "",
                "## ã‚ˆãã‚ã‚‹ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³",
                "",
                "### GameObjectè­˜åˆ¥æ–¹æ³•",
                "- gameObjectPath: éšå±¤ãƒ‘ã‚¹ï¼ˆä¾‹: 'Canvas/Panel/Button'ï¼‰",
                "- gameObjectGlobalObjectId: GlobalObjectIdæ–‡å­—åˆ—ï¼ˆã‚·ãƒ¼ãƒ³å†èª­ã¿è¾¼ã¿å¾Œã‚‚å®‰å®šã€éšå±¤ç§»å‹•ã«å¼·ã„ï¼‰",
                "- å„ªå…ˆé †ä½: GlobalObjectId > gameObjectPath",
                "",
                "### ã‚ˆãã‚ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£",
                "- Transform: position, rotation, localScale",
                "- RectTransform: anchoredPosition, sizeDelta, anchorMin, anchorMax, pivot, offsetMin, offsetMax",
                "- Text: text, fontSize, color, alignment",
                "- Image: sprite, color, raycastTarget",
                "- Button: interactable, onClick",
                "- Rigidbody: mass, drag, useGravity, constraints",
                "- Camera: fieldOfView, clearFlags, backgroundColor",
                "- Light: intensity, color, type, range",
                "",
                "### 3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³",
                "1. unity_gameobject_createFromTemplate(template='Cube'|'Sphere'|'Plane', position={...}, rotation={...}, scale={...})",
                "2. unity_component_crud(operation='add', componentType='UnityEngine.Rigidbody', propertyChanges={...})",
                "3. unity_asset_crud(operation='inspect', assetPath='Assets/Materials/...') ã§ãƒãƒ†ãƒªã‚¢ãƒ«ç¢ºèª",
                "4. unity_component_crud(operation='update', componentType='UnityEngine.MeshRenderer', propertyChanges={'material': 'Assets/Materials/...'})",
                "",
                "ãƒ„ãƒ¼ãƒ«åã¯å…¨ã¦ unity_* å½¢å¼ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢åŒºåˆ‡ã‚Šï¼‰ã€‚ä¾‹: unity_gameobject_crud, unity_component_crud",
            ]
        ),
    )

    register_resources(server)
    register_tools(server)

    return server

