# Model Context Protocol連携 要件定義書

## 1. 目的
Unity EditorからLLMへプロジェクト文脈を安全かつ即時に共有し、エンジニアがコード生成・レビュー・説明支援を受けられるMCPサーバーとUnityブリッジを構築する。日常の開発フローを阻害せず、再現可能なログと制御可能な権限設定を提供することをゴールとする。

## 2. スコープ
- 対象: MCP準拠サーバー実装、Unity Editor拡張（ブリッジ）、LLM接続設定、検証用ワークフロー。
- 除外: ランタイムビルド、ゲーム内UI変更、LLMプロンプトテンプレートの細部設計。

## 3. システム構成
- Unity Editor (Bridge): エディタ拡張メニュー、ウィンドウ、アセット選択/差分取得ロジック。
- MCP Server: Node.js + `@modelcontextprotocol/server`を基盤にしたHTTP/WebSocketサーバー。リソースプロバイダ、アクショントリガ、UnityブリッジとのRPC層を実装。
- LLM Provider: OpenAI互換API。APIキーはUnity側では保持せず、サーバー環境変数で管理。
- 通信: ブリッジ→サーバーはローカルホストWebSocket (ポート6006想定)。サーバー→LLMはHTTPS。

## 4. 機能要件
### 4.1 MCPサーバー
- `resources`: プロジェクトファイル要約、選択中アセットのテキスト化、アクティブシーン構成、Unity Editorログファイル (`%LOCALAPPDATA%/Unity/Editor/Editor.log` など) のローテーション読み取り。ログはブリッジとは独立したファイルウォッチャーで取得し、コンパイルエラーでブリッジが停止してもアクセス可能にする。
- `tools`: 
  - `pingUnityEditor`: Unity Editorとの接続確認。ブリッジは即時ACKでエディタ接続ステータスを返却。
  - `sceneManage`: シーンの新規作成、ロード、保存、削除。ブリッジが`SceneManager` APIを呼び出し、変更内容を差分として返す。
  - `gameObjectManage`: 現行シーン内のGameObject追加、削除、移動、リネーム、複製。結果はヒエラルキー構造をJSONで送信。
  - `componentManage`: 指定GameObjectへのコンポーネント追加・削除・プロパティ更新・状態取得。安全のため変更プレビューと明示承認を必須化。
  - `assetManage`: `Assets/`配下のスクリプト、プレハブ、マテリアル等の生成、更新、削除、メタデータ取得。ファイル書換え時はローカルディスクのバックアップコピーを作成。
  - スクリプト雛形生成、シリアライズ設定変更提案、プレイモード用テストコマンド実行 (`Unity.exe -batchmode ...` 呼び出し)。
- 特殊ツール: 
  - `uguiRectAdjust`。UGUI要素のRectTransform情報からスクリーン座標・ピクセルサイズを算出し、ヒエラルキー位置・大きさと実画面上の見え方の差分を補正する。調整結果をプレビューし、承認後にRectTransformへ反映。
  - `projectCompile`: AssetDatabase をリフレッシュし Unity にコンパイルを依頼、既定で完了を待機。可能な限りスクリプト変更をまとめてから実行し、エラーを一度で確認する。
- セッション管理: Unityブリッジ単位でセッションIDを維持し、LLMへの履歴送信を制御。
- 監査ログ: リクエスト/レスポンス、実行コマンド、ファイル書き込み操作を`Logs/MCP`に保存。

### 4.2 Unity Editorブリッジ
- メニュー: `Tools/MCP Assistant`から接続・切断・ログビューを提供。
- ウィンドウ: プロンプト入力、レスポンス表示、差分プレビュー、推奨アクション適用ボタン。
- コンテキスト抽出: 選択オブジェクト情報、`Assets/Scripts`, `Assets/Scenes`のパス、Git差分の抜粋をサーバーに送付。
- コマンド実行: MCPツール結果に応じたエディタAPI呼び出し（ファイル生成、設定変更）を安全確認ダイアログ経由で適用。

### 4.3 ユースケース
- スクリプト追加時のテンプレ生成。
- 既存コードレビューと改善提案提示。
- バグ報告ログの要約と再現手順生成。

## 5. 非機能要件
- レイテンシ: ブリッジ→サーバー往復 200ms以内 (LLM呼び出し除く)。
- 可観測性: サーバーは構成可能なログレベル、Unityウィンドウでの直近ステータス表示。
- 拡張性: 新リソース/ツール追加時に設定ファイル (`docs/mcp-config.json`)で宣言可能。
- 耐障害性: サーバー停止時はUnity側でフォールバック通知、再接続リトライ。

## 6. セキュリティ・設定
- APIキーは`.env`で管理しGit管理対象外。Unity側は署名付き一時トークンでサーバーに接続。
- ファイル書き込み系アクションはPreflight確認を必須化し、エディタログに記録。
- ローカルネットワーク以外で公開する場合はTLS終端を必須化。

## 7. テスト・検証
- 自動テスト: サーバーはJestでユニットテスト、エンドツーエンドはPlayModeテスト＋MCPモック。
- 手動テスト: エディタウィンドウ操作、接続断復旧、誤ったAPIキーのエラー表示確認。
- QA成果物: テストケース表、ログサンプル、既知課題一覧を`docs/mcp-test-plan.md`に集約。

## 8. 実装タスク
1. MCPサーバー基盤整備: Nodeプロジェクト初期化、MCPサーバースケルトン、環境変数管理、ロガー実装。
2. リソース/ツール実装: ファイル要約パイプライン、ログ提供、Unity CLIフック、権限ガード。
3. Unityブリッジ実装: メニュー＆ウィンドウUI、WebSocketクライアント、コンテキスト抽出サービス、安全適用フロー。
4. 運用基盤整備: `.env`テンプレ、起動スクリプト、ドキュメント、CIでのサニティチェック（lint + Jest）。
5. テスト/検証: サーバーユニットテスト整備、PlayMode自動化、結合テストと承認サインオフ手順策定。
