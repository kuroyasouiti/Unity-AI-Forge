using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// HP/damage system with invincibility, death behavior, and respawn support.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum DeathBehavior
    {
        Destroy,
        Disable,
        Respawn,
        Event
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string healthId = "{{HEALTH_ID}}";

    [Header("Health Settings")]
    [SerializeField] private float maxHealth = {{MAX_HEALTH}};
    [SerializeField] private float currentHealth = {{CURRENT_HEALTH}};

    [Header("Damage Settings")]
    [SerializeField] private float invincibilityDuration = {{INVINCIBILITY_DURATION}};
    [SerializeField] private bool canTakeDamage = true;

    [Header("Death Settings")]
    [SerializeField] private DeathBehavior onDeath = DeathBehavior.{{DEATH_BEHAVIOR}};
    [SerializeField] private Vector3 respawnPosition;
    [SerializeField] private float respawnDelay = {{RESPAWN_DELAY}};
    [SerializeField] private bool resetHealthOnRespawn = true;

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<float, float> OnHealthChanged = new UnityEvent<float, float>();
    public UnityEvent<float> OnDamaged = new UnityEvent<float>();
    public UnityEvent<float> OnHealed = new UnityEvent<float>();
    public UnityEvent OnDeath = new UnityEvent();
    public UnityEvent OnRespawn = new UnityEvent();
    public UnityEvent OnInvincibilityStart = new UnityEvent();
    public UnityEvent OnInvincibilityEnd = new UnityEvent();

    #endregion

    #region State

    [SerializeField] private bool isInvincible;
    private float invincibilityTimer;
    private bool isDead;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var h) ? h : null;
    }

    #endregion

    #region Properties

    public string HealthId => healthId;
    public float MaxHealth => maxHealth;
    public float CurrentHealth => currentHealth;
    public float HealthPercent => maxHealth > 0 ? currentHealth / maxHealth : 0f;
    public bool IsAlive => !isDead && currentHealth > 0;
    public bool IsDead => isDead;
    public bool IsInvincible => isInvincible;
    public bool CanTakeDamage => canTakeDamage && !isInvincible && !isDead;
    public DeathBehavior DeathBehaviorType => onDeath;
    public Vector3 RespawnPosition => respawnPosition;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        currentHealth = Mathf.Clamp(currentHealth, 0, maxHealth);
    }

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(healthId))
            _registry[healthId] = this;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(healthId))
            _registry.Remove(healthId);
    }

    private void Update()
    {
        if (isInvincible)
        {
            invincibilityTimer -= Time.deltaTime;
            if (invincibilityTimer <= 0)
            {
                isInvincible = false;
                OnInvincibilityEnd?.Invoke();
            }
        }
    }

    #endregion

    #region Public API

    public float TakeDamage(float amount)
    {
        if (!CanTakeDamage || amount <= 0)
            return 0f;

        float prev = currentHealth;
        currentHealth = Mathf.Max(0, currentHealth - amount);
        float actual = prev - currentHealth;

        if (actual > 0)
        {
            OnDamaged?.Invoke(actual);
            OnHealthChanged?.Invoke(currentHealth, maxHealth);

            if (invincibilityDuration > 0 && currentHealth > 0)
                StartInvincibility(invincibilityDuration);

            if (currentHealth <= 0 && !isDead)
                Die();
        }

        return actual;
    }

    public float Heal(float amount)
    {
        if (isDead || amount <= 0)
            return 0f;

        float prev = currentHealth;
        currentHealth = Mathf.Min(maxHealth, currentHealth + amount);
        float actual = currentHealth - prev;

        if (actual > 0)
        {
            OnHealed?.Invoke(actual);
            OnHealthChanged?.Invoke(currentHealth, maxHealth);
        }

        return actual;
    }

    public void SetHealth(float value)
    {
        float prev = currentHealth;
        currentHealth = Mathf.Clamp(value, 0, maxHealth);

        if (!Mathf.Approximately(prev, currentHealth))
        {
            OnHealthChanged?.Invoke(currentHealth, maxHealth);
            if (currentHealth <= 0 && !isDead)
                Die();
        }
    }

    public void SetMaxHealth(float value, bool adjustCurrentHealth = false)
    {
        float ratio = maxHealth > 0 ? currentHealth / maxHealth : 1f;
        maxHealth = Mathf.Max(1, value);
        currentHealth = adjustCurrentHealth ? maxHealth * ratio : Mathf.Min(currentHealth, maxHealth);
        OnHealthChanged?.Invoke(currentHealth, maxHealth);
    }

    public void Kill()
    {
        if (isDead) return;
        currentHealth = 0;
        OnHealthChanged?.Invoke(currentHealth, maxHealth);
        Die();
    }

    public void StartInvincibility(float duration)
    {
        if (duration <= 0) return;
        isInvincible = true;
        invincibilityTimer = duration;
        OnInvincibilityStart?.Invoke();
    }

    public void EndInvincibility()
    {
        if (!isInvincible) return;
        isInvincible = false;
        invincibilityTimer = 0;
        OnInvincibilityEnd?.Invoke();
    }

    public void Respawn()
    {
        isDead = false;
        isInvincible = false;
        if (resetHealthOnRespawn)
            currentHealth = maxHealth;
        transform.position = respawnPosition;
        gameObject.SetActive(true);
        OnHealthChanged?.Invoke(currentHealth, maxHealth);
        OnRespawn?.Invoke();
    }

    public void SetRespawnPosition(Vector3 position)
    {
        respawnPosition = position;
    }

    #endregion

    #region Internal

    private void Die()
    {
        isDead = true;
        OnDeath?.Invoke();

        switch (onDeath)
        {
            case DeathBehavior.Destroy:
                Destroy(gameObject);
                break;
            case DeathBehavior.Disable:
                gameObject.SetActive(false);
                break;
            case DeathBehavior.Respawn:
                StartCoroutine(RespawnAfterDelay());
                break;
            case DeathBehavior.Event:
                break;
        }
    }

    private IEnumerator RespawnAfterDelay()
    {
        if (respawnDelay > 0)
            yield return new WaitForSeconds(respawnDelay);
        Respawn();
    }

    #endregion

#if UNITY_EDITOR
    private void OnDrawGizmosSelected()
    {
        if (onDeath == DeathBehavior.Respawn)
        {
            Gizmos.color = Color.green;
            Gizmos.DrawWireSphere(respawnPosition, 0.5f);
            Gizmos.DrawLine(transform.position, respawnPosition);
        }
    }
#endif
}
