using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Pool;

/// <summary>
/// Object pool using Unity's built-in ObjectPool system.
/// Manages reusable instances of a prefab for performance optimization.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Settings

    [Header("Identity")]
    [SerializeField] private string poolId = "{{POOL_ID}}";

    [Header("Pool Configuration")]
    [SerializeField] private GameObject prefab;
    [SerializeField] private int initialSize = {{INITIAL_SIZE}};
    [SerializeField] private int maxSize = {{MAX_SIZE}};
    [SerializeField] private bool collectionCheck = {{COLLECTION_CHECK}};
    [SerializeField] private Transform defaultParent;

    #endregion

    #region State

    private ObjectPool<GameObject> pool;
    private bool isInitialized;
    private int totalCreated;
    private int totalGet;
    private int totalRelease;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var p) ? p : null;
    }

    #endregion

    #region Properties

    public string PoolId => poolId;
    public int CountActive => pool != null ? pool.CountActive : 0;
    public int CountInactive => pool != null ? pool.CountInactive : 0;
    public int CountAll => pool != null ? pool.CountAll : 0;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        InitializePool();
    }

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(poolId))
            _registry[poolId] = this;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(poolId))
            _registry.Remove(poolId);
    }

    private void OnDestroy()
    {
        if (pool != null)
        {
            pool.Clear();
            pool.Dispose();
        }
    }

    #endregion

    #region Public API

    /// <summary>
    /// Get an object from the pool. The object will be active and ready to use.
    /// </summary>
    public GameObject Get()
    {
        if (!isInitialized) InitializePool();
        totalGet++;
        return pool.Get();
    }

    /// <summary>
    /// Get an object from the pool at a specific position and rotation.
    /// </summary>
    public GameObject Get(Vector3 position, Quaternion rotation)
    {
        var obj = Get();
        obj.transform.position = position;
        obj.transform.rotation = rotation;
        return obj;
    }

    /// <summary>
    /// Return an object to the pool.
    /// </summary>
    public void Release(GameObject obj)
    {
        if (pool == null || obj == null) return;
        totalRelease++;
        pool.Release(obj);
    }

    /// <summary>
    /// Pre-instantiate objects to fill the pool.
    /// </summary>
    public void Warmup()
    {
        if (!isInitialized) InitializePool();

        var temp = new List<GameObject>();
        for (int i = 0; i < initialSize; i++)
        {
            temp.Add(pool.Get());
        }
        foreach (var obj in temp)
        {
            pool.Release(obj);
        }
    }

    /// <summary>
    /// Clear all pooled objects.
    /// </summary>
    public void Clear()
    {
        pool?.Clear();
    }

    /// <summary>
    /// Get pool statistics.
    /// </summary>
    public Dictionary<string, object> GetStats()
    {
        return new Dictionary<string, object>
        {
            { "poolId", poolId },
            { "countActive", CountActive },
            { "countInactive", CountInactive },
            { "countAll", CountAll },
            { "totalCreated", totalCreated },
            { "totalGet", totalGet },
            { "totalRelease", totalRelease }
        };
    }

    #endregion

    #region Internal

    private void InitializePool()
    {
        if (isInitialized) return;
        isInitialized = true;

        pool = new ObjectPool<GameObject>(
            createFunc: OnCreatePoolItem,
            actionOnGet: OnGetFromPool,
            actionOnRelease: OnReturnToPool,
            actionOnDestroy: OnDestroyPoolItem,
            collectionCheck: collectionCheck,
            defaultCapacity: initialSize,
            maxSize: maxSize
        );
    }

    private GameObject OnCreatePoolItem()
    {
        if (prefab == null)
        {
            Debug.LogError($"[{GetType().Name}] Prefab is not assigned for pool '{poolId}'.");
            return null;
        }

        totalCreated++;
        var parent = defaultParent != null ? defaultParent : transform;
        var obj = Instantiate(prefab, parent);
        obj.SetActive(false);
        return obj;
    }

    private void OnGetFromPool(GameObject obj)
    {
        if (obj != null)
            obj.SetActive(true);
    }

    private void OnReturnToPool(GameObject obj)
    {
        if (obj != null)
        {
            obj.SetActive(false);
            var parent = defaultParent != null ? defaultParent : transform;
            obj.transform.SetParent(parent);
        }
    }

    private void OnDestroyPoolItem(GameObject obj)
    {
        if (obj != null)
            Destroy(obj);
    }

    #endregion
}
