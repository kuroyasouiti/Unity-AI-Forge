using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// Central game manager hub with state management, resources, and turn phases.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum ManagerType
    {
        TurnBased,
        Realtime,
        ResourcePool,
        EventHub,
        StateManager
    }

    public enum GameState
    {
        Initializing,
        Playing,
        Paused,
        GameOver,
        Victory,
        Custom
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string managerId = "{{MANAGER_ID}}";

    [Header("Configuration")]
    [SerializeField] private ManagerType managerType = ManagerType.{{MANAGER_TYPE}};
    [SerializeField] private bool persistent = {{PERSISTENT}};

    #endregion

    #region Turn-Based

    [Header("Turn Settings")]
    [SerializeField] private List<string> turnPhases = new List<string>();
    [SerializeField] private int currentPhaseIndex;
    [SerializeField] private int currentTurnNumber;

    #endregion

    #region Resources

    [System.Serializable]
    public class ResourceEntry
    {
        public string name;
        public float amount;
        public float minValue;
        public float maxValue = float.MaxValue;
    }

    [Header("Resources")]
    [SerializeField] private List<ResourceEntry> resources = new List<ResourceEntry>();

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<GameState, GameState> OnGameStateChanged = new UnityEvent<GameState, GameState>();
    public UnityEvent<int> OnTurnChanged = new UnityEvent<int>();
    public UnityEvent<string> OnPhaseChanged = new UnityEvent<string>();
    public UnityEvent<string, float> OnResourceChanged = new UnityEvent<string, float>();
    public UnityEvent<string, object> OnCustomEvent = new UnityEvent<string, object>();

    #endregion

    #region State

    private GameState currentState = GameState.Initializing;
    private readonly Dictionary<string, object> customState = new Dictionary<string, object>();
    private readonly Dictionary<string, ResourceEntry> resourceLookup = new Dictionary<string, ResourceEntry>();

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var m) ? m : null;
    }

    #endregion

    #region Properties

    public string ManagerId => managerId;
    public ManagerType Type => managerType;
    public GameState CurrentState => currentState;
    public int CurrentTurn => currentTurnNumber;
    public string CurrentPhase => turnPhases.Count > 0 && currentPhaseIndex < turnPhases.Count
        ? turnPhases[currentPhaseIndex] : "";
    public bool IsPaused => currentState == GameState.Paused;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        if (persistent)
            DontDestroyOnLoad(gameObject);

        foreach (var r in resources)
        {
            if (!string.IsNullOrEmpty(r.name))
                resourceLookup[r.name] = r;
        }
    }

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(managerId))
            _registry[managerId] = this;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(managerId))
            _registry.Remove(managerId);
    }

    #endregion

    #region Game State

    public void SetState(GameState newState)
    {
        if (currentState == newState) return;
        var prev = currentState;
        currentState = newState;
        OnGameStateChanged?.Invoke(prev, newState);

        if (newState == GameState.Paused)
            Time.timeScale = 0f;
        else if (prev == GameState.Paused)
            Time.timeScale = 1f;
    }

    public void StartGame()
    {
        currentTurnNumber = 0;
        currentPhaseIndex = 0;
        SetState(GameState.Playing);
    }

    public void PauseGame() => SetState(GameState.Paused);
    public void ResumeGame() => SetState(GameState.Playing);
    public void GameOver() => SetState(GameState.GameOver);
    public void Victory() => SetState(GameState.Victory);

    #endregion

    #region Turn Management

    public void AddTurnPhase(string phase)
    {
        if (!turnPhases.Contains(phase))
            turnPhases.Add(phase);
    }

    public void NextPhase()
    {
        if (turnPhases.Count == 0) return;

        currentPhaseIndex++;
        if (currentPhaseIndex >= turnPhases.Count)
        {
            currentPhaseIndex = 0;
            currentTurnNumber++;
            OnTurnChanged?.Invoke(currentTurnNumber);
        }
        OnPhaseChanged?.Invoke(CurrentPhase);
    }

    public void NextTurn()
    {
        currentPhaseIndex = 0;
        currentTurnNumber++;
        OnTurnChanged?.Invoke(currentTurnNumber);
        OnPhaseChanged?.Invoke(CurrentPhase);
    }

    public void SetPhase(string phaseName)
    {
        int idx = turnPhases.IndexOf(phaseName);
        if (idx >= 0)
        {
            currentPhaseIndex = idx;
            OnPhaseChanged?.Invoke(CurrentPhase);
        }
    }

    #endregion

    #region Resource Management

    public float GetResource(string resourceName, float defaultValue = 0f)
    {
        return resourceLookup.TryGetValue(resourceName, out var r) ? r.amount : defaultValue;
    }

    public void SetResource(string resourceName, float amount)
    {
        if (!resourceLookup.TryGetValue(resourceName, out var r))
        {
            r = new ResourceEntry { name = resourceName, amount = 0, maxValue = float.MaxValue };
            resources.Add(r);
            resourceLookup[resourceName] = r;
        }
        r.amount = Mathf.Clamp(amount, r.minValue, r.maxValue);
        OnResourceChanged?.Invoke(resourceName, r.amount);
    }

    public void AddResource(string resourceName, float amount)
    {
        float current = GetResource(resourceName);
        SetResource(resourceName, current + amount);
    }

    public bool ConsumeResource(string resourceName, float amount)
    {
        float current = GetResource(resourceName);
        if (current < amount) return false;
        SetResource(resourceName, current - amount);
        return true;
    }

    public bool HasResource(string resourceName, float minAmount = 0)
    {
        return GetResource(resourceName) >= minAmount;
    }

    public Dictionary<string, float> GetAllResources()
    {
        var result = new Dictionary<string, float>();
        foreach (var r in resources)
            result[r.name] = r.amount;
        return result;
    }

    #endregion

    #region Custom State

    public void SetCustomState(string key, object value)
    {
        customState[key] = value;
    }

    public T GetCustomState<T>(string key, T defaultValue = default)
    {
        if (customState.TryGetValue(key, out var value) && value is T typedValue)
            return typedValue;
        return defaultValue;
    }

    public bool HasCustomState(string key)
    {
        return customState.ContainsKey(key);
    }

    #endregion

    #region Event Hub

    public void FireEvent(string eventName, object data = null)
    {
        OnCustomEvent?.Invoke(eventName, data);
    }

    #endregion
}
