using System;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.UIElements;

/// <summary>
/// Dynamic list/grid UI component for displaying collections using UI Toolkit.
/// Manages a ScrollView with programmatically created VisualElements.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum LayoutType
    {
        Vertical,
        Horizontal,
        Grid
    }

    public enum DataSourceType
    {
        Custom,
        Inventory,
        Equipment
    }

    [Serializable]
    public class ListItemData
    {
        public string id;
        public string name;
        public string description;
        public string iconPath;
        public int quantity = 1;
        public bool enabled = true;
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string listId = "{{LIST_ID}}";

    [Header("UI")]
    [SerializeField] private UIDocument uiDocument;

    [Header("Layout")]
    [SerializeField] private LayoutType layout = LayoutType.{{LAYOUT}};
    [SerializeField] private int columns = {{COLUMNS}};
    [SerializeField] private Vector2 cellSize = new Vector2({{CELL_SIZE_X}}, {{CELL_SIZE_Y}});
    [SerializeField] private Vector2 spacing = new Vector2({{SPACING_X}}, {{SPACING_Y}});

    [Header("Data")]
    [SerializeField] private DataSourceType dataSource = DataSourceType.{{DATA_SOURCE}};
    [SerializeField] private string sourceId = "{{SOURCE_ID}}";

    [Header("Selection")]
    [SerializeField] private bool selectable = {{SELECTABLE}};
    [SerializeField] private bool multiSelect = {{MULTI_SELECT}};

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<int, ListItemData> OnItemSelected = new UnityEvent<int, ListItemData>();
    public UnityEvent<int, ListItemData> OnItemDeselected = new UnityEvent<int, ListItemData>();
    public UnityEvent<int, ListItemData> OnItemClicked = new UnityEvent<int, ListItemData>();
    public UnityEvent<int, ListItemData> OnItemDoubleClicked = new UnityEvent<int, ListItemData>();
    public UnityEvent OnListUpdated = new UnityEvent();

    #endregion

    #region State

    private readonly List<ListItemData> items = new List<ListItemData>();
    private readonly List<VisualElement> itemElements = new List<VisualElement>();
    private readonly HashSet<int> selectedIndices = new HashSet<int>();
    private VisualElement listContainer;
    private float lastClickTime;
    private int lastClickIndex = -1;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var l) ? l : null;
    }

    #endregion

    #region Properties

    public string ListId => listId;
    public int ItemCount => items.Count;
    public IReadOnlyList<ListItemData> Items => items;
    public HashSet<int> SelectedIndices => selectedIndices;

    #endregion

    #region Lifecycle

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(listId))
            _registry[listId] = this;
        ResolveContainer();
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(listId))
            _registry.Remove(listId);
    }

    #endregion

    #region Public API

    public void SetItems(List<ListItemData> newItems)
    {
        items.Clear();
        if (newItems != null)
            items.AddRange(newItems);
        selectedIndices.Clear();
        RebuildUI();
        OnListUpdated?.Invoke();
    }

    public void AddItem(ListItemData item)
    {
        if (item == null) return;
        items.Add(item);
        CreateItemElement(items.Count - 1);
        OnListUpdated?.Invoke();
    }

    public void RemoveItemAt(int index)
    {
        if (index < 0 || index >= items.Count) return;
        items.RemoveAt(index);
        selectedIndices.Remove(index);
        RebuildUI();
        OnListUpdated?.Invoke();
    }

    public void Clear()
    {
        items.Clear();
        selectedIndices.Clear();
        ClearElements();
        OnListUpdated?.Invoke();
    }

    public void SelectItem(int index)
    {
        if (!selectable || index < 0 || index >= items.Count) return;

        if (!multiSelect)
        {
            foreach (var prev in selectedIndices)
            {
                UpdateItemVisual(prev, false);
                OnItemDeselected?.Invoke(prev, items[prev]);
            }
            selectedIndices.Clear();
        }

        selectedIndices.Add(index);
        UpdateItemVisual(index, true);
        OnItemSelected?.Invoke(index, items[index]);
    }

    public void DeselectItem(int index)
    {
        if (!selectable || index < 0 || index >= items.Count) return;
        if (selectedIndices.Remove(index))
        {
            UpdateItemVisual(index, false);
            OnItemDeselected?.Invoke(index, items[index]);
        }
    }

    public void ClearSelection()
    {
        foreach (var index in selectedIndices)
        {
            if (index < items.Count)
            {
                UpdateItemVisual(index, false);
                OnItemDeselected?.Invoke(index, items[index]);
            }
        }
        selectedIndices.Clear();
    }

    public List<ListItemData> GetSelectedItems()
    {
        var result = new List<ListItemData>();
        foreach (var index in selectedIndices)
        {
            if (index < items.Count)
                result.Add(items[index]);
        }
        return result;
    }

    public ListItemData GetItem(int index)
    {
        return index >= 0 && index < items.Count ? items[index] : null;
    }

    public int FindItemIndex(string itemId)
    {
        for (int i = 0; i < items.Count; i++)
        {
            if (items[i].id == itemId)
                return i;
        }
        return -1;
    }

    #endregion

    #region Internal

    private void ResolveContainer()
    {
        if (uiDocument == null)
            uiDocument = GetComponent<UIDocument>();
        if (uiDocument == null || uiDocument.rootVisualElement == null)
            return;

        var root = uiDocument.rootVisualElement;
        listContainer = root.Q("list-content") ?? root.Q<ScrollView>()?.contentContainer ?? root;
    }

    private void RebuildUI()
    {
        ClearElements();
        for (int i = 0; i < items.Count; i++)
            CreateItemElement(i);
    }

    private void ClearElements()
    {
        if (listContainer != null)
            listContainer.Clear();
        itemElements.Clear();
    }

    private void CreateItemElement(int index)
    {
        if (listContainer == null)
        {
            ResolveContainer();
            if (listContainer == null) return;
        }

        var item = items[index];

        var element = new VisualElement();
        element.name = $"item-{index}";
        element.AddToClassList("list-item");

        var label = new Label(item.name ?? "");
        label.name = "item-label";
        label.AddToClassList("list-item-label");
        element.Add(label);

        if (item.quantity > 1)
        {
            var qty = new Label($"x{item.quantity}");
            qty.name = "item-quantity";
            qty.AddToClassList("list-item-quantity");
            element.Add(qty);
        }

        int capturedIndex = index;
        element.RegisterCallback<ClickEvent>(evt => HandleItemClick(capturedIndex));

        listContainer.Add(element);
        itemElements.Add(element);

        UpdateItemVisual(index, selectedIndices.Contains(index));
    }

    private void HandleItemClick(int index)
    {
        if (index < 0 || index >= items.Count) return;

        OnItemClicked?.Invoke(index, items[index]);

        if (lastClickIndex == index && Time.unscaledTime - lastClickTime < 0.3f)
        {
            OnItemDoubleClicked?.Invoke(index, items[index]);
            lastClickIndex = -1;
            return;
        }
        lastClickTime = Time.unscaledTime;
        lastClickIndex = index;

        if (selectable)
        {
            if (selectedIndices.Contains(index))
                DeselectItem(index);
            else
                SelectItem(index);
        }
    }

    private void UpdateItemVisual(int index, bool selected)
    {
        if (index < 0 || index >= itemElements.Count) return;
        var element = itemElements[index];
        if (element == null) return;

        if (selected)
            element.AddToClassList("list-item--selected");
        else
            element.RemoveFromClassList("list-item--selected");
    }

    #endregion
}
