using System;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.UI;

/// <summary>
/// Dynamic list/grid UI component for displaying collections of items.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum LayoutType
    {
        Vertical,
        Horizontal,
        Grid
    }

    public enum DataSourceType
    {
        Custom,
        Inventory,
        Equipment
    }

    [Serializable]
    public class ListItemData
    {
        public string id;
        public string name;
        public string description;
        public Sprite icon;
        public int quantity = 1;
        public bool enabled = true;
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string listId = "{{LIST_ID}}";

    [Header("Layout")]
    [SerializeField] private LayoutType layout = LayoutType.{{LAYOUT}};
    [SerializeField] private int columns = {{COLUMNS}};
    [SerializeField] private Vector2 cellSize = new Vector2({{CELL_SIZE_X}}, {{CELL_SIZE_Y}});
    [SerializeField] private Vector2 spacing = new Vector2({{SPACING_X}}, {{SPACING_Y}});

    [Header("Items")]
    [SerializeField] private GameObject itemPrefab;
    [SerializeField] private Transform itemContainer;
    [SerializeField] private DataSourceType dataSource = DataSourceType.{{DATA_SOURCE}};
    [SerializeField] private string sourceId = "{{SOURCE_ID}}";

    [Header("Selection")]
    [SerializeField] private bool selectable = {{SELECTABLE}};
    [SerializeField] private bool multiSelect = {{MULTI_SELECT}};
    [SerializeField] private Color normalColor = Color.white;
    [SerializeField] private Color selectedColor = new Color(0.8f, 0.9f, 1f);
    [SerializeField] private Color hoverColor = new Color(0.9f, 0.95f, 1f);

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<int, ListItemData> OnItemSelected = new UnityEvent<int, ListItemData>();
    public UnityEvent<int, ListItemData> OnItemDeselected = new UnityEvent<int, ListItemData>();
    public UnityEvent<int, ListItemData> OnItemClicked = new UnityEvent<int, ListItemData>();
    public UnityEvent<int, ListItemData> OnItemDoubleClicked = new UnityEvent<int, ListItemData>();
    public UnityEvent OnListUpdated = new UnityEvent();

    #endregion

    #region State

    private readonly List<ListItemData> items = new List<ListItemData>();
    private readonly List<GameObject> itemInstances = new List<GameObject>();
    private readonly HashSet<int> selectedIndices = new HashSet<int>();
    private float lastClickTime;
    private int lastClickIndex = -1;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var l) ? l : null;
    }

    #endregion

    #region Properties

    public string ListId => listId;
    public int Count => items.Count;
    public IReadOnlyList<ListItemData> Items => items;

    #endregion

    #region Lifecycle

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(listId))
            _registry[listId] = this;
        if (itemContainer == null)
            itemContainer = transform;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(listId))
            _registry.Remove(listId);
    }

    #endregion

    #region Public API

    public void SetItems(List<ListItemData> newItems)
    {
        items.Clear();
        if (newItems != null)
            items.AddRange(newItems);
        selectedIndices.Clear();
        RebuildUI();
        OnListUpdated?.Invoke();
    }

    public void AddItem(ListItemData item)
    {
        if (item == null) return;
        items.Add(item);
        CreateItemInstance(items.Count - 1);
        OnListUpdated?.Invoke();
    }

    public void RemoveItemAt(int index)
    {
        if (index < 0 || index >= items.Count) return;
        items.RemoveAt(index);
        selectedIndices.Remove(index);
        RebuildUI();
        OnListUpdated?.Invoke();
    }

    public void Clear()
    {
        items.Clear();
        selectedIndices.Clear();
        ClearInstances();
        OnListUpdated?.Invoke();
    }

    public void SelectItem(int index)
    {
        if (!selectable || index < 0 || index >= items.Count) return;

        if (!multiSelect)
        {
            foreach (var prev in selectedIndices)
            {
                UpdateItemVisual(prev, false);
                OnItemDeselected?.Invoke(prev, items[prev]);
            }
            selectedIndices.Clear();
        }

        selectedIndices.Add(index);
        UpdateItemVisual(index, true);
        OnItemSelected?.Invoke(index, items[index]);
    }

    public void DeselectItem(int index)
    {
        if (!selectable || index < 0 || index >= items.Count) return;
        if (selectedIndices.Remove(index))
        {
            UpdateItemVisual(index, false);
            OnItemDeselected?.Invoke(index, items[index]);
        }
    }

    public void ClearSelection()
    {
        foreach (var index in selectedIndices)
        {
            if (index < items.Count)
            {
                UpdateItemVisual(index, false);
                OnItemDeselected?.Invoke(index, items[index]);
            }
        }
        selectedIndices.Clear();
    }

    public List<ListItemData> GetSelectedItems()
    {
        var result = new List<ListItemData>();
        foreach (var index in selectedIndices)
        {
            if (index < items.Count)
                result.Add(items[index]);
        }
        return result;
    }

    public ListItemData GetItem(int index)
    {
        return index >= 0 && index < items.Count ? items[index] : null;
    }

    public int FindItemIndex(string itemId)
    {
        for (int i = 0; i < items.Count; i++)
        {
            if (items[i].id == itemId)
                return i;
        }
        return -1;
    }

    #endregion

    #region Internal

    private void RebuildUI()
    {
        ClearInstances();
        for (int i = 0; i < items.Count; i++)
            CreateItemInstance(i);
    }

    private void ClearInstances()
    {
        foreach (var inst in itemInstances)
        {
            if (inst != null)
                Destroy(inst);
        }
        itemInstances.Clear();
    }

    private void CreateItemInstance(int index)
    {
        if (itemPrefab == null || itemContainer == null) return;

        var instance = Instantiate(itemPrefab, itemContainer);
        instance.name = $"Item_{index}";
        itemInstances.Add(instance);

        // Try to set item visuals
        var item = items[index];

        var label = instance.GetComponentInChildren<Text>();
        if (label != null) label.text = item.name ?? "";

        var icon = instance.transform.Find("Icon")?.GetComponent<Image>();
        if (icon != null && item.icon != null) icon.sprite = item.icon;

        // Add click handler
        var btn = instance.GetComponent<Button>();
        if (btn == null) btn = instance.AddComponent<Button>();

        int capturedIndex = index;
        btn.onClick.AddListener(() => HandleItemClick(capturedIndex));

        UpdateItemVisual(index, selectedIndices.Contains(index));
    }

    private void HandleItemClick(int index)
    {
        if (index < 0 || index >= items.Count) return;

        OnItemClicked?.Invoke(index, items[index]);

        // Double-click detection
        if (lastClickIndex == index && Time.unscaledTime - lastClickTime < 0.3f)
        {
            OnItemDoubleClicked?.Invoke(index, items[index]);
            lastClickIndex = -1;
            return;
        }
        lastClickTime = Time.unscaledTime;
        lastClickIndex = index;

        if (selectable)
        {
            if (selectedIndices.Contains(index))
                DeselectItem(index);
            else
                SelectItem(index);
        }
    }

    private void UpdateItemVisual(int index, bool selected)
    {
        if (index < 0 || index >= itemInstances.Count) return;
        var inst = itemInstances[index];
        if (inst == null) return;

        var image = inst.GetComponent<Image>();
        if (image != null)
            image.color = selected ? selectedColor : normalColor;
    }

    #endregion
}
