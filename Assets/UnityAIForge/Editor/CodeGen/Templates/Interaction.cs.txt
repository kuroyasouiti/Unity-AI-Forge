using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// Declarative interaction system with configurable triggers, actions, and conditions.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum TriggerType
    {
        Collision,
        Trigger,
        Raycast,
        Proximity,
        Input,
        TilemapCell,
        GraphNode,
        SplineProgress
    }

    public enum ActionType
    {
        SpawnPrefab,
        DestroyObject,
        PlaySound,
        SendMessage,
        ChangeScene,
        TriggerActorAction,
        UpdateManagerResource,
        TriggerSceneFlow,
        TeleportToTile,
        MoveToGraphNode,
        SetSplineProgress
    }

    public enum ConditionType
    {
        Tag,
        Layer,
        Distance,
        ActorId,
        ManagerResource,
        Custom
    }

    [System.Serializable]
    public class InteractionAction
    {
        public ActionType type;
        public string target;
        public string parameter;
        public GameObject targetObject;
        public float numericParameter;
    }

    [System.Serializable]
    public class InteractionCondition
    {
        public ConditionType type;
        public string value;
        public float numericValue;
        public bool negate;
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string interactionId = "{{INTERACTION_ID}}";

    [Header("Trigger")]
    [SerializeField] private TriggerType triggerType = TriggerType.{{TRIGGER_TYPE}};
    [SerializeField] private float proximityRadius = {{PROXIMITY_RADIUS}};
    [SerializeField] private KeyCode inputKey = KeyCode.{{INPUT_KEY}};

    [Header("Behavior")]
    [SerializeField] private bool allowRepeatedTrigger = {{ALLOW_REPEATED}};
    [SerializeField] private float triggerCooldown = {{TRIGGER_COOLDOWN}};
    [SerializeField] private bool logInteractions = false;

    [Header("Actions")]
    [SerializeField] private List<InteractionAction> actions = new List<InteractionAction>();

    [Header("Conditions")]
    [SerializeField] private List<InteractionCondition> conditions = new List<InteractionCondition>();

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<GameObject> OnInteractionTriggered = new UnityEvent<GameObject>();

    #endregion

    #region State

    private bool hasTriggered;
    private float lastTriggerTime;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var i) ? i : null;
    }

    #endregion

    #region Properties

    public string InteractionId => interactionId;
    public TriggerType CurrentTriggerType => triggerType;

    #endregion

    #region Lifecycle

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(interactionId))
            _registry[interactionId] = this;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(interactionId))
            _registry.Remove(interactionId);
    }

    private void Update()
    {
        if (triggerType == TriggerType.Input && UnityEngine.Input.GetKeyDown(inputKey))
        {
            ManualTrigger(gameObject);
        }

        if (triggerType == TriggerType.Proximity)
        {
            CheckProximity();
        }
    }

    #endregion

    #region Trigger Callbacks

    private void OnTriggerEnter(Collider other)
    {
        if (triggerType == TriggerType.Trigger)
            TryTrigger(other.gameObject);
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (triggerType == TriggerType.Trigger)
            TryTrigger(other.gameObject);
    }

    private void OnCollisionEnter(Collision collision)
    {
        if (triggerType == TriggerType.Collision)
            TryTrigger(collision.gameObject);
    }

    private void OnCollisionEnter2D(Collision2D collision)
    {
        if (triggerType == TriggerType.Collision)
            TryTrigger(collision.gameObject);
    }

    #endregion

    #region Public API

    public void ManualTrigger(GameObject triggeringObject)
    {
        TryTrigger(triggeringObject);
    }

    public void AddAction(ActionType type, string target, string parameter)
    {
        actions.Add(new InteractionAction
        {
            type = type,
            target = target,
            parameter = parameter
        });
    }

    public void AddCondition(ConditionType type, string value)
    {
        conditions.Add(new InteractionCondition
        {
            type = type,
            value = value
        });
    }

    public void ClearActions()
    {
        actions.Clear();
    }

    public void ClearConditions()
    {
        conditions.Clear();
    }

    #endregion

    #region Internal

    private void TryTrigger(GameObject triggeringObject)
    {
        if (!allowRepeatedTrigger && hasTriggered) return;
        if (triggerCooldown > 0 && Time.time - lastTriggerTime < triggerCooldown) return;
        if (!EvaluateConditions(triggeringObject)) return;

        hasTriggered = true;
        lastTriggerTime = Time.time;

        if (logInteractions)
            Debug.Log($"[{interactionId}] Triggered by {triggeringObject.name}");

        OnInteractionTriggered?.Invoke(triggeringObject);
        ExecuteActions(triggeringObject);
    }

    private bool EvaluateConditions(GameObject entity)
    {
        foreach (var condition in conditions)
        {
            bool result = EvaluateCondition(condition, entity);
            if (condition.negate) result = !result;
            if (!result) return false;
        }
        return true;
    }

    private bool EvaluateCondition(InteractionCondition condition, GameObject entity)
    {
        switch (condition.type)
        {
            case ConditionType.Tag:
                return entity.CompareTag(condition.value);

            case ConditionType.Layer:
                return entity.layer == LayerMask.NameToLayer(condition.value);

            case ConditionType.Distance:
                float maxDist = condition.numericValue > 0 ? condition.numericValue : float.Parse(condition.value);
                return Vector3.Distance(transform.position, entity.transform.position) <= maxDist;

            default:
                return true;
        }
    }

    private void ExecuteActions(GameObject triggeringObject)
    {
        foreach (var action in actions)
        {
            ExecuteAction(action, triggeringObject);
        }
    }

    private void ExecuteAction(InteractionAction action, GameObject triggeringObject)
    {
        GameObject target = ResolveTarget(action.target, triggeringObject);

        switch (action.type)
        {
            case ActionType.SpawnPrefab:
                if (!string.IsNullOrEmpty(action.parameter))
                {
                    var prefab = Resources.Load<GameObject>(action.parameter);
                    if (prefab != null)
                        Instantiate(prefab, transform.position, Quaternion.identity);
                }
                break;

            case ActionType.DestroyObject:
                if (target != null)
                    Destroy(target);
                break;

            case ActionType.PlaySound:
                if (target != null && !string.IsNullOrEmpty(action.parameter))
                {
                    var clip = Resources.Load<AudioClip>(action.parameter);
                    if (clip != null)
                        AudioSource.PlayClipAtPoint(clip, target.transform.position);
                }
                break;

            case ActionType.SendMessage:
                if (target != null && !string.IsNullOrEmpty(action.parameter))
                    target.SendMessage(action.parameter, triggeringObject, SendMessageOptions.DontRequireReceiver);
                break;

            case ActionType.ChangeScene:
                if (!string.IsNullOrEmpty(action.parameter))
                    UnityEngine.SceneManagement.SceneManager.LoadScene(action.parameter);
                break;
        }
    }

    private GameObject ResolveTarget(string targetRef, GameObject triggeringObject)
    {
        if (string.IsNullOrEmpty(targetRef) || targetRef == "self")
            return gameObject;
        if (targetRef == "trigger" || targetRef == "other")
            return triggeringObject;
        return GameObject.Find(targetRef);
    }

    private void CheckProximity()
    {
        var colliders = Physics.OverlapSphere(transform.position, proximityRadius);
        foreach (var col in colliders)
        {
            if (col.gameObject == gameObject) continue;
            TryTrigger(col.gameObject);
        }

        var colliders2D = Physics2D.OverlapCircleAll(transform.position, proximityRadius);
        foreach (var col in colliders2D)
        {
            if (col.gameObject == gameObject) continue;
            TryTrigger(col.gameObject);
        }
    }

    #endregion

#if UNITY_EDITOR
    private void OnDrawGizmosSelected()
    {
        if (triggerType == TriggerType.Proximity)
        {
            Gizmos.color = new Color(0f, 1f, 0.5f, 0.3f);
            Gizmos.DrawWireSphere(transform.position, proximityRadius);
        }
    }
#endif
}
