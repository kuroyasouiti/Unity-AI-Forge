using System;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.EventSystems;
using UnityEngine.UI;

/// <summary>
/// Item slot UI component for inventory, equipment, and quickslot systems.
/// Supports drag-and-drop item management.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour, IPointerClickHandler, IBeginDragHandler, IDragHandler, IEndDragHandler, IDropHandler
{
    #region Types

    public enum SlotType
    {
        Storage,
        Equipment,
        Quickslot,
        Trash
    }

    [Serializable]
    public class SlotData
    {
        public string itemId;
        public string itemName;
        public Sprite icon;
        public int quantity = 1;
        public string category;
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string slotId = "{{SLOT_ID}}";
    [SerializeField] private int slotIndex = {{SLOT_INDEX}};

    [Header("Slot Settings")]
    [SerializeField] private SlotType slotType = SlotType.{{SLOT_TYPE}};
    [SerializeField] private string equipSlotName = "{{EQUIP_SLOT_NAME}}";
    [SerializeField] private List<string> acceptCategories = new List<string>();
    [SerializeField] private string inventoryId = "{{INVENTORY_ID}}";

    [Header("UI References")]
    [SerializeField] private Image iconImage;
    [SerializeField] private Text quantityText;
    [SerializeField] private Image backgroundImage;
    [SerializeField] private Image highlightImage;

    [Header("Colors")]
    [SerializeField] private Color emptyColor = new Color(0.2f, 0.2f, 0.2f, 0.5f);
    [SerializeField] private Color filledColor = new Color(0.3f, 0.3f, 0.3f, 0.8f);
    [SerializeField] private Color highlightColor = new Color(0.5f, 0.7f, 1f, 0.5f);

    [Header("Drag & Drop")]
    [SerializeField] private bool dragDropEnabled = {{DRAG_DROP_ENABLED}};
    [SerializeField] private Canvas dragCanvas;

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<{{CLASS_NAME}}> OnSlotClicked = new UnityEvent<{{CLASS_NAME}}>();
    public UnityEvent<{{CLASS_NAME}}> OnSlotDoubleClicked = new UnityEvent<{{CLASS_NAME}}>();
    public UnityEvent<{{CLASS_NAME}}, {{CLASS_NAME}}> OnItemDropped = new UnityEvent<{{CLASS_NAME}}, {{CLASS_NAME}}>();
    public UnityEvent<{{CLASS_NAME}}> OnSlotChanged = new UnityEvent<{{CLASS_NAME}}>();

    #endregion

    #region State

    private SlotData currentItem;
    private GameObject dragIcon;
    private float lastClickTime;
    private bool isDragging;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var s) ? s : null;
    }

    #endregion

    #region Properties

    public string SlotId => slotId;
    public int SlotIndex => slotIndex;
    public SlotType Type => slotType;
    public string EquipSlotName => equipSlotName;
    public string InventoryId => inventoryId;
    public SlotData CurrentItem => currentItem;
    public bool IsEmpty => currentItem == null || string.IsNullOrEmpty(currentItem.itemId);
    public bool HasItem => !IsEmpty;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        AutoFindUIElements();
    }

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(slotId))
            _registry[slotId] = this;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(slotId))
            _registry.Remove(slotId);
    }

    #endregion

    #region Public API

    public void SetItem(SlotData item)
    {
        currentItem = item;
        RefreshVisuals();
        OnSlotChanged?.Invoke(this);
    }

    public void ClearSlot()
    {
        currentItem = null;
        RefreshVisuals();
        OnSlotChanged?.Invoke(this);
    }

    public bool CanAcceptItem(SlotData item)
    {
        if (item == null) return true;
        if (acceptCategories == null || acceptCategories.Count == 0) return true;
        return !string.IsNullOrEmpty(item.category) && acceptCategories.Contains(item.category);
    }

    public void SetHighlight(bool show)
    {
        if (highlightImage != null)
            highlightImage.enabled = show;
    }

    public void RefreshVisuals()
    {
        if (IsEmpty)
        {
            if (iconImage != null) { iconImage.sprite = null; iconImage.enabled = false; }
            if (quantityText != null) quantityText.text = "";
            if (backgroundImage != null) backgroundImage.color = emptyColor;
        }
        else
        {
            if (iconImage != null) { iconImage.sprite = currentItem.icon; iconImage.enabled = currentItem.icon != null; }
            if (quantityText != null) quantityText.text = currentItem.quantity > 1 ? currentItem.quantity.ToString() : "";
            if (backgroundImage != null) backgroundImage.color = filledColor;
        }
    }

    #endregion

    #region Event Handlers

    public void OnPointerClick(PointerEventData eventData)
    {
        if (Time.unscaledTime - lastClickTime < 0.3f)
        {
            OnSlotDoubleClicked?.Invoke(this);
            lastClickTime = 0;
            return;
        }
        lastClickTime = Time.unscaledTime;
        OnSlotClicked?.Invoke(this);
    }

    public void OnBeginDrag(PointerEventData eventData)
    {
        if (!dragDropEnabled || IsEmpty) return;
        isDragging = true;

        var canvas = dragCanvas != null ? dragCanvas : GetComponentInParent<Canvas>();
        if (canvas == null) return;

        dragIcon = new GameObject("DragIcon");
        dragIcon.transform.SetParent(canvas.transform, false);
        var img = dragIcon.AddComponent<Image>();
        img.sprite = currentItem.icon;
        img.raycastTarget = false;
        var rt = dragIcon.GetComponent<RectTransform>();
        rt.sizeDelta = new Vector2(50, 50);
    }

    public void OnDrag(PointerEventData eventData)
    {
        if (!isDragging || dragIcon == null) return;
        dragIcon.transform.position = eventData.position;
    }

    public void OnEndDrag(PointerEventData eventData)
    {
        isDragging = false;
        if (dragIcon != null)
            Destroy(dragIcon);
    }

    public void OnDrop(PointerEventData eventData)
    {
        if (!dragDropEnabled) return;

        var sourceSlot = eventData.pointerDrag?.GetComponent<{{CLASS_NAME}}>();
        if (sourceSlot == null || sourceSlot == this) return;

        if (!CanAcceptItem(sourceSlot.CurrentItem)) return;

        // Swap items
        var sourceItem = sourceSlot.CurrentItem;
        var targetItem = currentItem;

        SetItem(sourceItem);
        sourceSlot.SetItem(targetItem);

        OnItemDropped?.Invoke(sourceSlot, this);
    }

    #endregion

    #region Internal

    private void AutoFindUIElements()
    {
        if (iconImage == null)
            iconImage = transform.Find("Icon")?.GetComponent<Image>();
        if (quantityText == null)
            quantityText = transform.Find("QuantityText")?.GetComponent<Text>();
        if (backgroundImage == null)
            backgroundImage = GetComponent<Image>();
        if (highlightImage == null)
            highlightImage = transform.Find("Highlight")?.GetComponent<Image>();
    }

    #endregion
}
