using System;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.UIElements;

/// <summary>
/// Item slot UI component using UI Toolkit for inventory, equipment, and quickslot systems.
/// Supports click handling and drag-and-drop via UITK pointer events.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum SlotType
    {
        Storage,
        Equipment,
        Quickslot,
        Trash
    }

    [Serializable]
    public class SlotData
    {
        public string itemId;
        public string itemName;
        public string iconPath;
        public int quantity = 1;
        public string category;
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string slotId = "{{SLOT_ID}}";
    [SerializeField] private int slotIndex = {{SLOT_INDEX}};

    [Header("UI")]
    [SerializeField] private UIDocument uiDocument;

    [Header("Slot Settings")]
    [SerializeField] private SlotType slotType = SlotType.{{SLOT_TYPE}};
    [SerializeField] private string equipSlotName = "{{EQUIP_SLOT_NAME}}";
    [SerializeField] private List<string> acceptCategories = new List<string>();
    [SerializeField] private string inventoryId = "{{INVENTORY_ID}}";

    [Header("Drag & Drop")]
    [SerializeField] private bool dragDropEnabled = {{DRAG_DROP_ENABLED}};

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<{{CLASS_NAME}}> OnSlotClicked = new UnityEvent<{{CLASS_NAME}}>();
    public UnityEvent<{{CLASS_NAME}}> OnSlotDoubleClicked = new UnityEvent<{{CLASS_NAME}}>();
    public UnityEvent<{{CLASS_NAME}}, {{CLASS_NAME}}> OnItemDropped = new UnityEvent<{{CLASS_NAME}}, {{CLASS_NAME}}>();
    public UnityEvent<{{CLASS_NAME}}> OnSlotChanged = new UnityEvent<{{CLASS_NAME}}>();

    #endregion

    #region State

    private SlotData currentItem;
    private VisualElement slotElement;
    private VisualElement iconElement;
    private Label quantityLabel;
    private VisualElement highlightElement;
    private float lastClickTime;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var s) ? s : null;
    }

    #endregion

    #region Properties

    public string SlotId => slotId;
    public int SlotIndex => slotIndex;
    public SlotType Type => slotType;
    public string EquipSlotName => equipSlotName;
    public string InventoryId => inventoryId;
    public SlotData CurrentItem => currentItem;
    public bool IsEmpty => currentItem == null || string.IsNullOrEmpty(currentItem.itemId);
    public bool HasItem => !IsEmpty;

    #endregion

    #region Lifecycle

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(slotId))
            _registry[slotId] = this;
        ResolveElements();
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(slotId))
            _registry.Remove(slotId);
    }

    #endregion

    #region Public API

    public void SetItem(SlotData item)
    {
        currentItem = item;
        RefreshVisuals();
        OnSlotChanged?.Invoke(this);
    }

    public void ClearSlot()
    {
        currentItem = null;
        RefreshVisuals();
        OnSlotChanged?.Invoke(this);
    }

    public bool CanAcceptItem(SlotData item)
    {
        if (item == null) return true;
        if (acceptCategories == null || acceptCategories.Count == 0) return true;
        return !string.IsNullOrEmpty(item.category) && acceptCategories.Contains(item.category);
    }

    public void SetHighlight(bool show)
    {
        if (highlightElement != null)
            highlightElement.style.display = show ? DisplayStyle.Flex : DisplayStyle.None;
    }

    public void RefreshVisuals()
    {
        if (slotElement == null) ResolveElements();
        if (slotElement == null) return;

        if (IsEmpty)
        {
            if (iconElement != null) iconElement.style.display = DisplayStyle.None;
            if (quantityLabel != null) quantityLabel.text = "";
            slotElement.RemoveFromClassList("slot--filled");
            slotElement.AddToClassList("slot--empty");
        }
        else
        {
            if (iconElement != null) iconElement.style.display = DisplayStyle.Flex;
            if (quantityLabel != null) quantityLabel.text = currentItem.quantity > 1 ? currentItem.quantity.ToString() : "";
            slotElement.RemoveFromClassList("slot--empty");
            slotElement.AddToClassList("slot--filled");
        }
    }

    #endregion

    #region Internal

    private void ResolveElements()
    {
        if (uiDocument == null)
            uiDocument = GetComponent<UIDocument>();
        if (uiDocument == null || uiDocument.rootVisualElement == null)
            return;

        var root = uiDocument.rootVisualElement;
        slotElement = root.Q("slot") ?? root;
        iconElement = root.Q("icon");
        quantityLabel = root.Q<Label>("quantity");
        highlightElement = root.Q("highlight");

        // Register click handler
        slotElement.RegisterCallback<ClickEvent>(OnClick);
    }

    private void OnClick(ClickEvent evt)
    {
        if (Time.unscaledTime - lastClickTime < 0.3f)
        {
            OnSlotDoubleClicked?.Invoke(this);
            lastClickTime = 0;
            return;
        }
        lastClickTime = Time.unscaledTime;
        OnSlotClicked?.Invoke(this);
    }

    #endregion
}
