using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// Dialogue system manager with node traversal, choices, conditions, and actions.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum NodeType { Dialogue, Choice, Branch, Action, Exit }
    public enum ConditionType { Quest, Resource, Inventory, Variable, Health, Custom }
    public enum ActionType { StartQuest, CompleteQuest, AddResource, RemoveResource, AddItem, RemoveItem, SetVariable, PlayEffect, Custom }

    [System.Serializable]
    public class DialogueNode
    {
        public string nodeId;
        public NodeType type = NodeType.Dialogue;
        public string speaker;
        public string text;
        public string nextNodeId;
        public List<DialogueChoice> choices = new List<DialogueChoice>();
        public List<DialogueCondition> conditions = new List<DialogueCondition>();
        public List<DialogueAction> actions = new List<DialogueAction>();
    }

    [System.Serializable]
    public class DialogueChoice
    {
        public string choiceId;
        public string text;
        public string targetNodeId;
        public List<DialogueCondition> conditions = new List<DialogueCondition>();
        public List<DialogueAction> actions = new List<DialogueAction>();
    }

    [System.Serializable]
    public class DialogueCondition
    {
        public ConditionType type;
        public string target;
        public string property;
        public string comparison;
        public string value;
        public bool negate;
    }

    [System.Serializable]
    public class DialogueAction
    {
        public ActionType type;
        public string target;
        public string parameter;
        public float numericValue;
    }

    [System.Serializable]
    public class DialogueData
    {
        public string dialogueId;
        public List<DialogueNode> nodes = new List<DialogueNode>();
        public string startNodeId = "start";
        public bool autoAdvance;
        public float autoAdvanceDelay = 2f;
    }

    #endregion

    #region Settings

    [Header("Settings")]
    [SerializeField] private string dialogueManagerId = "{{DIALOGUE_MANAGER_ID}}";
    [SerializeField] private float defaultTypingSpeed = {{DEFAULT_TYPING_SPEED}};
    [SerializeField] private bool pauseGameDuringDialogue = {{PAUSE_GAME}};

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<DialogueData, DialogueNode> OnDialogueStart = new UnityEvent<DialogueData, DialogueNode>();
    public UnityEvent<DialogueNode> OnNodeEnter = new UnityEvent<DialogueNode>();
    public UnityEvent<List<DialogueChoice>> OnChoicesAvailable = new UnityEvent<List<DialogueChoice>>();
    public UnityEvent<DialogueChoice> OnChoiceSelected = new UnityEvent<DialogueChoice>();
    public UnityEvent OnDialogueEnd = new UnityEvent();
    public UnityEvent<DialogueAction> OnActionExecuted = new UnityEvent<DialogueAction>();

    #endregion

    #region State

    private static {{CLASS_NAME}} _instance;
    private DialogueData currentDialogue;
    private DialogueNode currentNode;
    private bool isDialogueActive;
    private Coroutine autoAdvanceCoroutine;
    private readonly Dictionary<string, object> dialogueVariables = new Dictionary<string, object>();
    private readonly Dictionary<string, DialogueData> dialogueRegistry = new Dictionary<string, DialogueData>();

    #endregion

    #region Properties

    public static {{CLASS_NAME}} Instance => _instance;
    public bool IsDialogueActive => isDialogueActive;
    public DialogueNode CurrentNode => currentNode;
    public string CurrentSpeaker => currentNode?.speaker;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        if (_instance != null && _instance != this)
        {
            Destroy(gameObject);
            return;
        }
        _instance = this;
    }

    private void OnDestroy()
    {
        if (_instance == this)
            _instance = null;
    }

    #endregion

    #region Public API

    public void RegisterDialogue(DialogueData data)
    {
        if (data != null && !string.IsNullOrEmpty(data.dialogueId))
            dialogueRegistry[data.dialogueId] = data;
    }

    public void StartDialogue(string dialogueId)
    {
        if (dialogueRegistry.TryGetValue(dialogueId, out var data))
            StartDialogue(data);
    }

    public void StartDialogue(DialogueData data)
    {
        if (data == null || data.nodes.Count == 0) return;

        currentDialogue = data;
        isDialogueActive = true;

        if (pauseGameDuringDialogue)
            Time.timeScale = 0f;

        var startNode = data.nodes.Find(n => n.nodeId == data.startNodeId)
            ?? data.nodes[0];

        OnDialogueStart?.Invoke(data, startNode);
        GoToNode(startNode);
    }

    public void GoToNode(string nodeId)
    {
        if (currentDialogue == null) return;
        var node = currentDialogue.nodes.Find(n => n.nodeId == nodeId);
        if (node != null)
            GoToNode(node);
        else
            EndDialogue();
    }

    public void GoToNode(DialogueNode node)
    {
        if (autoAdvanceCoroutine != null)
        {
            StopCoroutine(autoAdvanceCoroutine);
            autoAdvanceCoroutine = null;
        }

        currentNode = node;
        OnNodeEnter?.Invoke(node);

        foreach (var action in node.actions)
            ExecuteAction(action);

        switch (node.type)
        {
            case NodeType.Dialogue:
                if (node.choices.Count > 0)
                {
                    var available = FilterChoices(node.choices);
                    if (available.Count > 0)
                        OnChoicesAvailable?.Invoke(available);
                }
                else if (currentDialogue.autoAdvance)
                {
                    autoAdvanceCoroutine = StartCoroutine(AutoAdvance(currentDialogue.autoAdvanceDelay));
                }
                break;

            case NodeType.Choice:
                var choices = FilterChoices(node.choices);
                OnChoicesAvailable?.Invoke(choices);
                break;

            case NodeType.Branch:
                ProcessBranch(node);
                break;

            case NodeType.Action:
                AdvanceDialogue();
                break;

            case NodeType.Exit:
                EndDialogue();
                break;
        }
    }

    public void SelectChoice(int index)
    {
        if (currentNode == null) return;
        var choices = FilterChoices(currentNode.choices);
        if (index < 0 || index >= choices.Count) return;

        var choice = choices[index];
        OnChoiceSelected?.Invoke(choice);

        foreach (var action in choice.actions)
            ExecuteAction(action);

        if (!string.IsNullOrEmpty(choice.targetNodeId))
            GoToNode(choice.targetNodeId);
        else
            AdvanceDialogue();
    }

    public void AdvanceDialogue()
    {
        if (currentNode == null) { EndDialogue(); return; }
        if (!string.IsNullOrEmpty(currentNode.nextNodeId))
            GoToNode(currentNode.nextNodeId);
        else
            EndDialogue();
    }

    public void EndDialogue()
    {
        if (autoAdvanceCoroutine != null)
        {
            StopCoroutine(autoAdvanceCoroutine);
            autoAdvanceCoroutine = null;
        }

        isDialogueActive = false;
        currentDialogue = null;
        currentNode = null;

        if (pauseGameDuringDialogue)
            Time.timeScale = 1f;

        OnDialogueEnd?.Invoke();
    }

    public void SetVariable(string key, object value)
    {
        dialogueVariables[key] = value;
    }

    public T GetVariable<T>(string key, T defaultValue = default)
    {
        if (dialogueVariables.TryGetValue(key, out var value) && value is T typedValue)
            return typedValue;
        return defaultValue;
    }

    #endregion

    #region Internal

    private List<DialogueChoice> FilterChoices(List<DialogueChoice> choices)
    {
        var result = new List<DialogueChoice>();
        foreach (var choice in choices)
        {
            if (EvaluateConditions(choice.conditions))
                result.Add(choice);
        }
        return result;
    }

    private bool EvaluateConditions(List<DialogueCondition> conditions)
    {
        foreach (var condition in conditions)
        {
            bool result = EvaluateCondition(condition);
            if (condition.negate) result = !result;
            if (!result) return false;
        }
        return true;
    }

    private bool EvaluateCondition(DialogueCondition condition)
    {
        switch (condition.type)
        {
            case ConditionType.Variable:
                if (dialogueVariables.TryGetValue(condition.target, out var varValue))
                    return varValue?.ToString() == condition.value;
                return false;

            default:
                return true;
        }
    }

    private void ProcessBranch(DialogueNode node)
    {
        foreach (var choice in node.choices)
        {
            if (EvaluateConditions(choice.conditions))
            {
                if (!string.IsNullOrEmpty(choice.targetNodeId))
                    GoToNode(choice.targetNodeId);
                return;
            }
        }

        if (!string.IsNullOrEmpty(node.nextNodeId))
            GoToNode(node.nextNodeId);
        else
            EndDialogue();
    }

    private void ExecuteAction(DialogueAction action)
    {
        OnActionExecuted?.Invoke(action);
    }

    private IEnumerator AutoAdvance(float delay)
    {
        yield return new WaitForSecondsRealtime(delay);
        AdvanceDialogue();
    }

    #endregion
}
