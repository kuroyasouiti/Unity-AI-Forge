using System.Collections.Generic;
using System.IO;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// Save/load system with slot management and auto-save support.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    [System.Serializable]
    public class SaveSlotInfo
    {
        public string slotId;
        public string timestamp;
        public string displayName;
    }

    [System.Serializable]
    public class SaveData
    {
        public string slotId;
        public string timestamp;
        public List<SaveEntry> entries = new List<SaveEntry>();
    }

    [System.Serializable]
    public class SaveEntry
    {
        public string key;
        public string value;
        public string type;
    }

    #endregion

    #region Settings

    [Header("Settings")]
    [SerializeField] private bool persistent = {{PERSISTENT}};
    [SerializeField] private string saveDirectory = "{{SAVE_DIRECTORY}}";
    [SerializeField] private string fileExtension = "{{FILE_EXTENSION}}";

    [Header("Auto-Save")]
    [SerializeField] private bool autoSaveEnabled = {{AUTO_SAVE_ENABLED}};
    [SerializeField] private float autoSaveInterval = {{AUTO_SAVE_INTERVAL}};
    [SerializeField] private string autoSaveSlotId = "{{AUTO_SAVE_SLOT_ID}}";

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<string, string> OnSaveComplete = new UnityEvent<string, string>();
    public UnityEvent<string, string> OnLoadComplete = new UnityEvent<string, string>();
    public UnityEvent<string, string> OnSaveError = new UnityEvent<string, string>();
    public UnityEvent<string, string> OnLoadError = new UnityEvent<string, string>();
    public UnityEvent<string> OnSlotDeleted = new UnityEvent<string>();

    #endregion

    #region State

    private static {{CLASS_NAME}} _instance;
    private float autoSaveTimer;
    private readonly Dictionary<string, System.Func<string>> dataCollectors =
        new Dictionary<string, System.Func<string>>();

    #endregion

    #region Properties

    public static {{CLASS_NAME}} Instance => _instance;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        if (_instance != null && _instance != this)
        {
            Destroy(gameObject);
            return;
        }
        _instance = this;
        if (persistent)
            DontDestroyOnLoad(gameObject);
    }

    private void OnDestroy()
    {
        if (_instance == this)
            _instance = null;
    }

    private void Update()
    {
        if (autoSaveEnabled)
        {
            autoSaveTimer += Time.unscaledDeltaTime;
            if (autoSaveTimer >= autoSaveInterval)
            {
                autoSaveTimer = 0;
                Save(autoSaveSlotId);
            }
        }
    }

    private void OnApplicationPause(bool pause)
    {
        if (pause && autoSaveEnabled)
            Save(autoSaveSlotId);
    }

    #endregion

    #region Public API

    public void RegisterDataCollector(string key, System.Func<string> collector)
    {
        dataCollectors[key] = collector;
    }

    public void UnregisterDataCollector(string key)
    {
        dataCollectors.Remove(key);
    }

    public void Save(string slotId)
    {
        try
        {
            var data = new SaveData
            {
                slotId = slotId,
                timestamp = System.DateTime.Now.ToString("o")
            };

            foreach (var kvp in dataCollectors)
            {
                try
                {
                    string value = kvp.Value?.Invoke();
                    if (value != null)
                    {
                        data.entries.Add(new SaveEntry
                        {
                            key = kvp.Key,
                            value = value,
                            type = "json"
                        });
                    }
                }
                catch (System.Exception e)
                {
                    Debug.LogWarning($"[Save] Failed to collect data for '{kvp.Key}': {e.Message}");
                }
            }

            string json = JsonUtility.ToJson(data, true);
            string path = GetSlotPath(slotId);
            string dir = Path.GetDirectoryName(path);
            if (!Directory.Exists(dir))
                Directory.CreateDirectory(dir);

            File.WriteAllText(path, json);
            OnSaveComplete?.Invoke(slotId, path);
        }
        catch (System.Exception e)
        {
            OnSaveError?.Invoke(slotId, e.Message);
        }
    }

    public SaveData Load(string slotId)
    {
        try
        {
            string path = GetSlotPath(slotId);
            if (!File.Exists(path))
            {
                OnLoadError?.Invoke(slotId, "Save file not found");
                return null;
            }

            string json = File.ReadAllText(path);
            var data = JsonUtility.FromJson<SaveData>(json);
            OnLoadComplete?.Invoke(slotId, path);
            return data;
        }
        catch (System.Exception e)
        {
            OnLoadError?.Invoke(slotId, e.Message);
            return null;
        }
    }

    public string GetEntryValue(SaveData data, string key)
    {
        if (data == null) return null;
        var entry = data.entries.Find(e => e.key == key);
        return entry?.value;
    }

    public void DeleteSlot(string slotId)
    {
        string path = GetSlotPath(slotId);
        if (File.Exists(path))
        {
            File.Delete(path);
            OnSlotDeleted?.Invoke(slotId);
        }
    }

    public List<SaveSlotInfo> GetSlots()
    {
        var result = new List<SaveSlotInfo>();
        string dir = GetSaveDirectory();
        if (!Directory.Exists(dir)) return result;

        foreach (var file in Directory.GetFiles(dir, $"*{fileExtension}"))
        {
            try
            {
                string json = File.ReadAllText(file);
                var data = JsonUtility.FromJson<SaveData>(json);
                result.Add(new SaveSlotInfo
                {
                    slotId = data.slotId,
                    timestamp = data.timestamp,
                    displayName = data.slotId
                });
            }
            catch { }
        }

        return result;
    }

    public bool SlotExists(string slotId)
    {
        return File.Exists(GetSlotPath(slotId));
    }

    #endregion

    #region Internal

    private string GetSaveDirectory()
    {
        return Path.Combine(Application.persistentDataPath, saveDirectory);
    }

    private string GetSlotPath(string slotId)
    {
        return Path.Combine(GetSaveDirectory(), slotId + fileExtension);
    }

    #endregion
}
