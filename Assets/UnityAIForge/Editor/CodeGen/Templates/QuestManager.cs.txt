using System.Collections.Generic;
using System.Linq;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// Quest tracking system with objectives, prerequisites, and rewards.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum QuestStateType { Available, Active, Completed, Failed }
    public enum ObjectiveType { Kill, Collect, Talk, Location, Interact, Escort, Defend, Deliver, Explore, Craft, Custom }

    [System.Serializable]
    public class QuestDefinition
    {
        public string questId;
        public string title;
        public string description;
        public string category;
        public bool autoComplete = true;
        public bool repeatable;
        public List<QuestObjective> objectives = new List<QuestObjective>();
        public List<QuestReward> rewards = new List<QuestReward>();
        public List<string> prerequisiteQuests = new List<string>();
    }

    [System.Serializable]
    public class QuestObjective
    {
        public string objectiveId;
        public ObjectiveType type;
        public string description;
        public string targetId;
        public int requiredCount = 1;
    }

    [System.Serializable]
    public class QuestReward
    {
        public string rewardId;
        public string type;
        public string target;
        public float amount;
        public string itemId;
    }

    [System.Serializable]
    public class QuestState
    {
        public string questId;
        public QuestStateType state;
        public Dictionary<string, int> objectiveProgress = new Dictionary<string, int>();
        public float startTime;
    }

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<string> OnQuestStarted = new UnityEvent<string>();
    public UnityEvent<string, string, int, int> OnObjectiveUpdated = new UnityEvent<string, string, int, int>();
    public UnityEvent<string, string> OnObjectiveCompleted = new UnityEvent<string, string>();
    public UnityEvent<string> OnQuestCompleted = new UnityEvent<string>();
    public UnityEvent<string> OnQuestFailed = new UnityEvent<string>();
    public UnityEvent<string> OnQuestAbandoned = new UnityEvent<string>();

    #endregion

    #region State

    private static {{CLASS_NAME}} _instance;
    private readonly Dictionary<string, QuestDefinition> questRegistry = new Dictionary<string, QuestDefinition>();
    private readonly Dictionary<string, QuestState> activeQuests = new Dictionary<string, QuestState>();
    private readonly Dictionary<string, QuestState> completedQuests = new Dictionary<string, QuestState>();
    private readonly HashSet<string> failedQuests = new HashSet<string>();

    #endregion

    #region Properties

    public static {{CLASS_NAME}} Instance => _instance;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        if (_instance != null && _instance != this)
        {
            Destroy(gameObject);
            return;
        }
        _instance = this;
    }

    private void OnDestroy()
    {
        if (_instance == this)
            _instance = null;
    }

    #endregion

    #region Public API

    public void RegisterQuest(QuestDefinition quest)
    {
        if (quest != null && !string.IsNullOrEmpty(quest.questId))
            questRegistry[quest.questId] = quest;
    }

    public bool CanStartQuest(string questId)
    {
        if (!questRegistry.TryGetValue(questId, out var quest)) return false;
        if (activeQuests.ContainsKey(questId)) return false;
        if (completedQuests.ContainsKey(questId) && !quest.repeatable) return false;

        foreach (var prereq in quest.prerequisiteQuests)
        {
            if (!completedQuests.ContainsKey(prereq)) return false;
        }

        return true;
    }

    public bool StartQuest(string questId)
    {
        if (!CanStartQuest(questId)) return false;

        var quest = questRegistry[questId];
        var state = new QuestState
        {
            questId = questId,
            state = QuestStateType.Active,
            startTime = Time.time
        };

        foreach (var obj in quest.objectives)
            state.objectiveProgress[obj.objectiveId] = 0;

        activeQuests[questId] = state;
        OnQuestStarted?.Invoke(questId);
        return true;
    }

    public void UpdateObjective(string questId, string objectiveId, int progress)
    {
        if (!activeQuests.TryGetValue(questId, out var state)) return;
        if (!questRegistry.TryGetValue(questId, out var quest)) return;

        var objective = quest.objectives.Find(o => o.objectiveId == objectiveId);
        if (objective == null) return;

        state.objectiveProgress[objectiveId] = Mathf.Min(progress, objective.requiredCount);
        OnObjectiveUpdated?.Invoke(questId, objectiveId, progress, objective.requiredCount);

        if (progress >= objective.requiredCount)
            OnObjectiveCompleted?.Invoke(questId, objectiveId);

        if (quest.autoComplete && AreAllObjectivesComplete(questId))
            CompleteQuest(questId);
    }

    public void IncrementObjective(string questId, string objectiveId, int amount = 1)
    {
        if (!activeQuests.TryGetValue(questId, out var state)) return;
        int current = state.objectiveProgress.TryGetValue(objectiveId, out var p) ? p : 0;
        UpdateObjective(questId, objectiveId, current + amount);
    }

    public void CompleteQuest(string questId)
    {
        if (!activeQuests.TryGetValue(questId, out var state)) return;
        state.state = QuestStateType.Completed;
        activeQuests.Remove(questId);
        completedQuests[questId] = state;

        if (questRegistry.TryGetValue(questId, out var quest))
            GrantRewards(quest);

        OnQuestCompleted?.Invoke(questId);
    }

    public void FailQuest(string questId)
    {
        if (!activeQuests.ContainsKey(questId)) return;
        activeQuests.Remove(questId);
        failedQuests.Add(questId);
        OnQuestFailed?.Invoke(questId);
    }

    public void AbandonQuest(string questId)
    {
        if (!activeQuests.ContainsKey(questId)) return;
        activeQuests.Remove(questId);
        OnQuestAbandoned?.Invoke(questId);
    }

    public bool IsQuestActive(string questId) => activeQuests.ContainsKey(questId);
    public bool IsQuestCompleted(string questId) => completedQuests.ContainsKey(questId);

    public QuestState GetQuestState(string questId)
    {
        if (activeQuests.TryGetValue(questId, out var s)) return s;
        if (completedQuests.TryGetValue(questId, out s)) return s;
        return null;
    }

    public int GetObjectiveProgress(string questId, string objectiveId)
    {
        if (!activeQuests.TryGetValue(questId, out var state)) return 0;
        return state.objectiveProgress.TryGetValue(objectiveId, out var p) ? p : 0;
    }

    public List<string> GetActiveQuestIds()
    {
        return new List<string>(activeQuests.Keys);
    }

    public List<string> GetCompletedQuestIds()
    {
        return new List<string>(completedQuests.Keys);
    }

    #endregion

    #region Internal

    private bool AreAllObjectivesComplete(string questId)
    {
        if (!activeQuests.TryGetValue(questId, out var state)) return false;
        if (!questRegistry.TryGetValue(questId, out var quest)) return false;

        foreach (var obj in quest.objectives)
        {
            int progress = state.objectiveProgress.TryGetValue(obj.objectiveId, out var p) ? p : 0;
            if (progress < obj.requiredCount) return false;
        }
        return true;
    }

    private void GrantRewards(QuestDefinition quest)
    {
        foreach (var reward in quest.rewards)
        {
            // Rewards are granted via events - listeners handle the actual reward delivery
            // This keeps the quest system decoupled from specific game systems
        }
    }

    #endregion

    #region Save/Load

    [System.Serializable]
    public class QuestSaveData
    {
        public List<QuestStateSave> active = new List<QuestStateSave>();
        public List<QuestStateSave> completed = new List<QuestStateSave>();
        public List<string> failed = new List<string>();
    }

    [System.Serializable]
    public class QuestStateSave
    {
        public string questId;
        public List<string> objectiveIds = new List<string>();
        public List<int> objectiveProgress = new List<int>();
    }

    public string GetSaveData()
    {
        var data = new QuestSaveData();
        foreach (var kvp in activeQuests)
        {
            var save = new QuestStateSave { questId = kvp.Key };
            foreach (var op in kvp.Value.objectiveProgress)
            {
                save.objectiveIds.Add(op.Key);
                save.objectiveProgress.Add(op.Value);
            }
            data.active.Add(save);
        }
        foreach (var kvp in completedQuests)
            data.completed.Add(new QuestStateSave { questId = kvp.Key });
        data.failed.AddRange(failedQuests);
        return JsonUtility.ToJson(data);
    }

    public void LoadSaveData(string json)
    {
        if (string.IsNullOrEmpty(json)) return;
        var data = JsonUtility.FromJson<QuestSaveData>(json);

        activeQuests.Clear();
        completedQuests.Clear();
        failedQuests.Clear();

        foreach (var save in data.active)
        {
            var state = new QuestState
            {
                questId = save.questId,
                state = QuestStateType.Active
            };
            for (int i = 0; i < save.objectiveIds.Count; i++)
                state.objectiveProgress[save.objectiveIds[i]] = save.objectiveProgress[i];
            activeQuests[save.questId] = state;
        }

        foreach (var save in data.completed)
        {
            completedQuests[save.questId] = new QuestState
            {
                questId = save.questId,
                state = QuestStateType.Completed
            };
        }

        foreach (var id in data.failed)
            failedQuests.Add(id);
    }

    #endregion
}
