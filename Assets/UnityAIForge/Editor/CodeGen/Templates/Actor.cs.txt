using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// Game actor hub â€” handles identity, movement abstraction, and state.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum BehaviorProfile
    {
        Linear2D,
        Physics2D,
        TileGrid,
        GraphNode,
        SplineMovement,
        CharacterController3D,
        Physics3D,
        NavMesh
    }

    public enum ControlMode
    {
        DirectController,
        AIAutonomous,
        UICommand,
        ScriptTriggerOnly
    }

    public enum ActorState
    {
        Idle,
        Moving,
        Jumping,
        Attacking,
        Hit,
        Dead,
        Custom
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string actorId = "{{ACTOR_ID}}";

    [Header("Profile")]
    [SerializeField] private BehaviorProfile behaviorProfile = BehaviorProfile.{{BEHAVIOR_PROFILE}};
    [SerializeField] private ControlMode controlMode = ControlMode.{{CONTROL_MODE}};

    [Header("Movement")]
    [SerializeField] private float moveSpeed = {{MOVE_SPEED}};
    [SerializeField] private float acceleration = {{ACCELERATION}};
    [SerializeField] private float jumpForce = {{JUMP_FORCE}};

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<string, object> OnActionReceived = new UnityEvent<string, object>();
    public UnityEvent<ActorState, ActorState> OnStateChanged = new UnityEvent<ActorState, ActorState>();
    public UnityEvent<Vector3> OnMoved = new UnityEvent<Vector3>();

    #endregion

    #region State

    private ActorState currentState = ActorState.Idle;
    private Vector3 moveInput;
    private Vector3 velocity;
    private bool isGrounded;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var a) ? a : null;
    }

    #endregion

    #region Properties

    public string ActorId => actorId;
    public BehaviorProfile Profile => behaviorProfile;
    public ControlMode Control => controlMode;
    public ActorState CurrentState => currentState;
    public float MoveSpeed => moveSpeed;
    public Vector3 Velocity => velocity;
    public bool IsGrounded => isGrounded;

    #endregion

    #region Lifecycle

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(actorId))
            _registry[actorId] = this;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(actorId))
            _registry.Remove(actorId);
    }

    private void FixedUpdate()
    {
        if (moveInput.sqrMagnitude > 0.001f)
            ApplyMovement();
    }

    #endregion

    #region Public API

    public void SetMoveInput(Vector3 input)
    {
        moveInput = Vector3.ClampMagnitude(input, 1f);
        if (moveInput.sqrMagnitude > 0.001f && currentState != ActorState.Dead)
            ChangeState(ActorState.Moving);
        else if (moveInput.sqrMagnitude <= 0.001f && currentState == ActorState.Moving)
            ChangeState(ActorState.Idle);
    }

    public void SetMoveInput2D(Vector2 input)
    {
        SetMoveInput(new Vector3(input.x, input.y, 0f));
    }

    public void Jump()
    {
        if (currentState == ActorState.Dead) return;

        var rb = GetComponent<Rigidbody>();
        var rb2d = GetComponent<Rigidbody2D>();

        if (rb != null)
            rb.AddForce(Vector3.up * jumpForce, ForceMode.Impulse);
        else if (rb2d != null)
            rb2d.AddForce(Vector2.up * jumpForce, ForceMode2D.Impulse);

        ChangeState(ActorState.Jumping);
    }

    public void SendAction(string actionName, object parameter = null)
    {
        OnActionReceived?.Invoke(actionName, parameter);
    }

    public void ChangeState(ActorState newState)
    {
        if (currentState == newState) return;
        var prev = currentState;
        currentState = newState;
        OnStateChanged?.Invoke(prev, newState);
    }

    public void Stop()
    {
        moveInput = Vector3.zero;
        velocity = Vector3.zero;

        var rb = GetComponent<Rigidbody>();
        var rb2d = GetComponent<Rigidbody2D>();

        if (rb != null)
            rb.linearVelocity = Vector3.zero;
        else if (rb2d != null)
            rb2d.linearVelocity = Vector2.zero;

        if (currentState == ActorState.Moving)
            ChangeState(ActorState.Idle);
    }

    public void SetMoveSpeed(float speed)
    {
        moveSpeed = Mathf.Max(0, speed);
    }

    #endregion

    #region Internal

    private void ApplyMovement()
    {
        Vector3 targetVelocity = moveInput * moveSpeed;

        if (acceleration > 0)
            velocity = Vector3.Lerp(velocity, targetVelocity, acceleration * Time.fixedDeltaTime);
        else
            velocity = targetVelocity;

        var rb = GetComponent<Rigidbody>();
        var rb2d = GetComponent<Rigidbody2D>();
        var cc = GetComponent<CharacterController>();

        if (rb != null)
        {
            rb.MovePosition(rb.position + velocity * Time.fixedDeltaTime);
        }
        else if (rb2d != null)
        {
            rb2d.MovePosition(rb2d.position + (Vector2)velocity * Time.fixedDeltaTime);
        }
        else if (cc != null)
        {
            cc.Move(velocity * Time.fixedDeltaTime);
        }
        else
        {
            transform.position += velocity * Time.fixedDeltaTime;
        }

        OnMoved?.Invoke(velocity);
    }

    #endregion
}
