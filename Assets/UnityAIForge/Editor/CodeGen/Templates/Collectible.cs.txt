using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// Collectible item with animation, collection behavior, and respawn support.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum CollectibleType
    {
        Coin,
        Health,
        Mana,
        PowerUp,
        Key,
        Ammo,
        Experience,
        Custom
    }

    public enum CollectionBehavior
    {
        Destroy,
        Disable,
        Respawn
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string collectibleId = "{{COLLECTIBLE_ID}}";

    [Header("Collectible Settings")]
    [SerializeField] private CollectibleType collectibleType = CollectibleType.{{COLLECTIBLE_TYPE}};
    [SerializeField] private CollectionBehavior collectionBehavior = CollectionBehavior.{{COLLECTION_BEHAVIOR}};
    [SerializeField] private string customTypeName = "{{CUSTOM_TYPE_NAME}}";
    [SerializeField] private float value = {{VALUE}};
    [SerializeField] private int intValue = {{INT_VALUE}};
    [SerializeField] private bool collectable = {{COLLECTABLE}};

    [Header("Filtering")]
    [SerializeField] private string requiredTag = "{{REQUIRED_TAG}}";

    [Header("Respawn")]
    [SerializeField] private float respawnDelay = {{RESPAWN_DELAY}};

    [Header("Float Animation")]
    [SerializeField] private bool enableFloatAnimation = {{ENABLE_FLOAT_ANIMATION}};
    [SerializeField] private float floatAmplitude = {{FLOAT_AMPLITUDE}};
    [SerializeField] private float floatFrequency = {{FLOAT_FREQUENCY}};

    [Header("Rotation Animation")]
    [SerializeField] private bool enableRotation = {{ENABLE_ROTATION}};
    [SerializeField] private float rotationSpeed = {{ROTATION_SPEED}};
    [SerializeField] private Vector3 rotationAxis = {{ROTATION_AXIS}};

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<GameObject> OnCollected = new UnityEvent<GameObject>();
    public UnityEvent OnRespawned = new UnityEvent();

    #endregion

    #region State

    private Vector3 startPosition;
    private bool isCollected;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var c) ? c : null;
    }

    #endregion

    #region Properties

    public string CollectibleId => collectibleId;
    public CollectibleType Type => collectibleType;
    public float Value => value;
    public int IntValue => intValue;
    public bool IsCollected => isCollected;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        startPosition = transform.position;
    }

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(collectibleId))
            _registry[collectibleId] = this;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(collectibleId))
            _registry.Remove(collectibleId);
    }

    private void Update()
    {
        if (isCollected) return;

        if (enableFloatAnimation)
        {
            float offset = Mathf.Sin(Time.time * floatFrequency * Mathf.PI * 2f) * floatAmplitude;
            transform.position = startPosition + Vector3.up * offset;
        }

        if (enableRotation)
        {
            transform.Rotate(rotationAxis, rotationSpeed * Time.deltaTime);
        }
    }

    #endregion

    #region Trigger Callbacks

    private void OnTriggerEnter(Collider other)
    {
        TryCollect(other.gameObject);
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        TryCollect(other.gameObject);
    }

    #endregion

    #region Public API

    public void Collect(GameObject collector)
    {
        if (isCollected || !collectable) return;
        isCollected = true;

        ApplyEffect(collector);
        OnCollected?.Invoke(collector);

        switch (collectionBehavior)
        {
            case CollectionBehavior.Destroy:
                Destroy(gameObject);
                break;
            case CollectionBehavior.Disable:
                gameObject.SetActive(false);
                break;
            case CollectionBehavior.Respawn:
                gameObject.SetActive(false);
                StartCoroutine(RespawnRoutine());
                break;
        }
    }

    public void Respawn()
    {
        isCollected = false;
        transform.position = startPosition;
        gameObject.SetActive(true);
        OnRespawned?.Invoke();
    }

    public void ResetCollectible()
    {
        isCollected = false;
    }

    #endregion

    #region Internal

    private void TryCollect(GameObject collector)
    {
        if (!collectable || isCollected) return;
        if (!string.IsNullOrEmpty(requiredTag) && !collector.CompareTag(requiredTag)) return;
        Collect(collector);
    }

    private void ApplyEffect(GameObject collector)
    {
        switch (collectibleType)
        {
            case CollectibleType.Health:
                collector.SendMessage("Heal", value, SendMessageOptions.DontRequireReceiver);
                break;
            case CollectibleType.Coin:
            case CollectibleType.Experience:
            case CollectibleType.Mana:
                collector.SendMessage("AddResource",
                    new object[] { collectibleType.ToString().ToLower(), value },
                    SendMessageOptions.DontRequireReceiver);
                break;
        }
    }

    private IEnumerator RespawnRoutine()
    {
        yield return new WaitForSeconds(respawnDelay);
        Respawn();
    }

    #endregion
}
