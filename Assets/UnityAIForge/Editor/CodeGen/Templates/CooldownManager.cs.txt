using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// Manages multiple named cooldowns on a single component.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    [System.Serializable]
    public class CooldownEntry
    {
        public string id;
        public float duration = 1f;
        public bool startReady = true;

        [System.NonSerialized] public float timer;
        [System.NonSerialized] public bool isReady;
    }

    #endregion

    #region Settings

    [Header("Cooldowns")]
    [SerializeField] private List<CooldownEntry> cooldowns = new List<CooldownEntry>();

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<string> OnCooldownTriggered = new UnityEvent<string>();
    public UnityEvent<string> OnCooldownReady = new UnityEvent<string>();

    #endregion

    #region State

    private readonly Dictionary<string, CooldownEntry> lookup = new Dictionary<string, CooldownEntry>();

    #endregion

    #region Lifecycle

    private void Awake()
    {
        foreach (var cd in cooldowns)
        {
            cd.isReady = cd.startReady;
            cd.timer = cd.startReady ? 0f : cd.duration;
            if (!string.IsNullOrEmpty(cd.id))
                lookup[cd.id] = cd;
        }
    }

    private void Update()
    {
        float dt = Time.deltaTime;
        foreach (var cd in cooldowns)
        {
            if (!cd.isReady)
            {
                cd.timer -= dt;
                if (cd.timer <= 0)
                {
                    cd.isReady = true;
                    cd.timer = 0;
                    OnCooldownReady?.Invoke(cd.id);
                }
            }
        }
    }

    #endregion

    #region Public API

    public bool IsReady(string id)
    {
        return lookup.TryGetValue(id, out var cd) && cd.isReady;
    }

    public bool TryTrigger(string id)
    {
        if (!lookup.TryGetValue(id, out var cd) || !cd.isReady)
            return false;
        cd.isReady = false;
        cd.timer = cd.duration;
        OnCooldownTriggered?.Invoke(id);
        return true;
    }

    public void Trigger(string id)
    {
        if (lookup.TryGetValue(id, out var cd))
        {
            cd.isReady = false;
            cd.timer = cd.duration;
            OnCooldownTriggered?.Invoke(id);
        }
    }

    public void ResetCooldown(string id)
    {
        if (lookup.TryGetValue(id, out var cd))
        {
            cd.isReady = true;
            cd.timer = 0;
            OnCooldownReady?.Invoke(id);
        }
    }

    public void ResetAll()
    {
        foreach (var cd in cooldowns)
        {
            cd.isReady = true;
            cd.timer = 0;
        }
    }

    public float GetRemaining(string id)
    {
        return lookup.TryGetValue(id, out var cd) ? Mathf.Max(0, cd.timer) : 0f;
    }

    public float GetProgress(string id)
    {
        if (!lookup.TryGetValue(id, out var cd)) return 1f;
        return cd.duration > 0 ? 1f - Mathf.Clamp01(cd.timer / cd.duration) : 1f;
    }

    public void AddCooldown(string id, float duration, bool startReady = true)
    {
        if (lookup.ContainsKey(id)) return;
        var cd = new CooldownEntry
        {
            id = id,
            duration = duration,
            startReady = startReady,
            isReady = startReady,
            timer = startReady ? 0f : duration
        };
        cooldowns.Add(cd);
        lookup[id] = cd;
    }

    public void SetDuration(string id, float duration)
    {
        if (lookup.TryGetValue(id, out var cd))
            cd.duration = Mathf.Max(0, duration);
    }

    #endregion
}
