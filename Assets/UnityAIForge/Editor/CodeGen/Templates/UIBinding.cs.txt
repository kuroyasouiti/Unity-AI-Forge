using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.UI;

/// <summary>
/// Declarative UI data binding that connects game state to UI elements.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum SourceType
    {
        Health,
        Economy,
        Timer,
        Custom
    }

    public enum ValueFormat
    {
        Raw,
        Percent,
        Formatted,
        Ratio
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string bindingId = "{{BINDING_ID}}";

    [Header("Source")]
    [SerializeField] private SourceType sourceType = SourceType.{{SOURCE_TYPE}};
    [SerializeField] private string sourceId = "{{SOURCE_ID}}";

    [Header("Target")]
    [SerializeField] private GameObject targetObject;
    [SerializeField] private string targetComponentType = "{{TARGET_COMPONENT_TYPE}}";
    [SerializeField] private string targetProperty = "{{TARGET_PROPERTY}}";

    [Header("Format")]
    [SerializeField] private ValueFormat format = ValueFormat.{{FORMAT}};
    [SerializeField] private string formatString = "{{FORMAT_STRING}}";
    [SerializeField] private float minValue = {{MIN_VALUE}};
    [SerializeField] private float maxValue = {{MAX_VALUE}};

    [Header("Update")]
    [SerializeField] private float updateInterval = {{UPDATE_INTERVAL}};
    [SerializeField] private bool smoothTransition = {{SMOOTH_TRANSITION}};
    [SerializeField] private float smoothSpeed = {{SMOOTH_SPEED}};

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<float> OnValueChanged = new UnityEvent<float>();
    public UnityEvent<float> OnPercentChanged = new UnityEvent<float>();
    public UnityEvent<string> OnFormattedValueChanged = new UnityEvent<string>();

    #endregion

    #region State

    private float currentValue;
    private float displayValue;
    private float updateTimer;

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var b) ? b : null;
    }

    #endregion

    #region Properties

    public string BindingId => bindingId;
    public SourceType Source => sourceType;
    public string SourceId => sourceId;
    public ValueFormat Format => format;
    public float CurrentValue => currentValue;
    public float DisplayValue => displayValue;
    public float Percent => maxValue > minValue ? Mathf.Clamp01((currentValue - minValue) / (maxValue - minValue)) : 0f;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        if (targetObject == null)
            targetObject = gameObject;
    }

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(bindingId))
            _registry[bindingId] = this;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(bindingId))
            _registry.Remove(bindingId);
    }

    private void Update()
    {
        updateTimer -= Time.deltaTime;
        if (updateTimer <= 0f)
        {
            updateTimer = updateInterval;
            Refresh();
        }

        if (smoothTransition && !Mathf.Approximately(displayValue, currentValue))
        {
            displayValue = Mathf.Lerp(displayValue, currentValue, Time.deltaTime * smoothSpeed);
            ApplyToTarget(displayValue);
        }
    }

    #endregion

    #region Public API

    public void SetValue(float value)
    {
        var prev = currentValue;
        currentValue = Mathf.Clamp(value, minValue, maxValue);

        if (!Mathf.Approximately(prev, currentValue))
        {
            OnValueChanged?.Invoke(currentValue);
            OnPercentChanged?.Invoke(Percent);
            OnFormattedValueChanged?.Invoke(GetFormattedValue());

            if (!smoothTransition)
            {
                displayValue = currentValue;
                ApplyToTarget(displayValue);
            }
        }
    }

    public void SetRange(float min, float max)
    {
        minValue = min;
        maxValue = max;
        SetValue(currentValue);
    }

    public string GetFormattedValue()
    {
        return format switch
        {
            ValueFormat.Raw => currentValue.ToString("F0"),
            ValueFormat.Percent => $"{Percent * 100f:F0}%",
            ValueFormat.Formatted => string.Format(formatString, currentValue, maxValue, Percent),
            ValueFormat.Ratio => $"{currentValue:F0}/{maxValue:F0}",
            _ => currentValue.ToString()
        };
    }

    public void Refresh()
    {
        // Override this method or use SetValue() to push data from your game systems.
        // Example: SetValue(playerHealth.CurrentHealth);
    }

    #endregion

    #region Internal

    private void ApplyToTarget(float value)
    {
        if (targetObject == null) return;

        // Auto-detect common UI component types
        var slider = targetObject.GetComponent<Slider>();
        if (slider != null)
        {
            slider.value = format == ValueFormat.Percent ? Percent : value;
            return;
        }

        var image = targetObject.GetComponent<Image>();
        if (image != null && image.type == Image.Type.Filled)
        {
            image.fillAmount = Percent;
            return;
        }

        var text = targetObject.GetComponent<Text>();
        if (text != null)
        {
            text.text = GetFormattedValue();
            return;
        }

        // Try TextMeshPro via reflection
        var tmpType = targetObject.GetComponent("TMP_Text");
        if (tmpType != null)
        {
            var textProp = tmpType.GetType().GetProperty("text");
            textProp?.SetValue(tmpType, GetFormattedValue());
        }
    }

    #endregion
}
