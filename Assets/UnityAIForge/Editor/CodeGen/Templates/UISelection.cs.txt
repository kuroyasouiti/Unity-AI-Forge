using System;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.UI;

/// <summary>
/// Selection group UI component supporting radio, toggle, checkbox, and tab modes.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    public enum SelectionType
    {
        Radio,
        Toggle,
        Checkbox,
        Tab
    }

    public enum LayoutType
    {
        Horizontal,
        Vertical,
        Grid
    }

    [Serializable]
    public class SelectionItem
    {
        public string id;
        public string label;
        public Sprite icon;
        public bool enabled = true;
        public bool defaultSelected;
        public GameObject associatedPanel;
    }

    [Serializable]
    public class SelectionAction
    {
        public string selectedId;
        public List<string> showPaths;
        public List<string> hidePaths;
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string selectionId = "{{SELECTION_ID}}";

    [Header("Selection")]
    [SerializeField] private SelectionType selectionType = SelectionType.{{SELECTION_TYPE}};
    [SerializeField] private bool allowNone = {{ALLOW_NONE}};
    [SerializeField] private int defaultIndex = {{DEFAULT_INDEX}};

    [Header("Layout")]
    [SerializeField] private LayoutType layout = LayoutType.{{LAYOUT}};
    [SerializeField] private float spacing = {{SPACING}};

    [Header("Items")]
    [SerializeField] private GameObject itemPrefab;
    [SerializeField] private Transform itemContainer;

    [Header("Colors")]
    [SerializeField] private Color normalColor = new Color(0.8f, 0.8f, 0.8f);
    [SerializeField] private Color selectedColor = new Color(0.3f, 0.6f, 1f);
    [SerializeField] private Color hoverColor = new Color(0.9f, 0.9f, 0.9f);
    [SerializeField] private Color disabledColor = new Color(0.5f, 0.5f, 0.5f);

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<string, int> OnSelectionChanged = new UnityEvent<string, int>();
    public UnityEvent<string> OnItemSelected = new UnityEvent<string>();
    public UnityEvent<string> OnItemDeselected = new UnityEvent<string>();
    public UnityEvent<List<string>> OnMultiSelectionChanged = new UnityEvent<List<string>>();

    #endregion

    #region State

    private readonly List<SelectionItem> items = new List<SelectionItem>();
    private readonly List<GameObject> itemInstances = new List<GameObject>();
    private readonly HashSet<int> selectedIndices = new HashSet<int>();
    private List<SelectionAction> selectionActions = new List<SelectionAction>();

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var s) ? s : null;
    }

    #endregion

    #region Properties

    public string SelectionId => selectionId;
    public SelectionType Type => selectionType;
    public int Count => items.Count;
    public IReadOnlyList<SelectionItem> SelectionItems => items;

    #endregion

    #region Lifecycle

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(selectionId))
            _registry[selectionId] = this;
        if (itemContainer == null)
            itemContainer = transform;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(selectionId))
            _registry.Remove(selectionId);
    }

    private void Start()
    {
        if (defaultIndex >= 0 && defaultIndex < items.Count)
            SelectItem(defaultIndex, false);
    }

    #endregion

    #region Public API

    public void SetItems(List<SelectionItem> newItems)
    {
        items.Clear();
        if (newItems != null)
            items.AddRange(newItems);
        selectedIndices.Clear();
        RebuildUI();
    }

    public void AddItem(SelectionItem item)
    {
        if (item == null) return;
        items.Add(item);
        CreateItemInstance(items.Count - 1);
    }

    public void RemoveItemAt(int index)
    {
        if (index < 0 || index >= items.Count) return;
        items.RemoveAt(index);
        selectedIndices.Remove(index);
        RebuildUI();
    }

    public void Clear()
    {
        items.Clear();
        selectedIndices.Clear();
        ClearInstances();
    }

    public void SetSelectionActions(List<SelectionAction> actions)
    {
        selectionActions = actions ?? new List<SelectionAction>();
    }

    public void SelectItem(int index, bool fireEvents = true)
    {
        if (index < 0 || index >= items.Count) return;
        if (!items[index].enabled) return;

        bool isSingleSelect = selectionType == SelectionType.Radio || selectionType == SelectionType.Tab;

        if (isSingleSelect)
        {
            foreach (var prev in selectedIndices)
            {
                UpdateItemVisual(prev, false);
                if (fireEvents) OnItemDeselected?.Invoke(items[prev].id);
            }
            selectedIndices.Clear();
        }

        if (selectionType == SelectionType.Toggle && selectedIndices.Contains(index))
        {
            DeselectItem(index, fireEvents);
            return;
        }

        if (selectionType == SelectionType.Checkbox && selectedIndices.Contains(index))
        {
            DeselectItem(index, fireEvents);
            return;
        }

        selectedIndices.Add(index);
        UpdateItemVisual(index, true);

        // Handle associated panels
        if (selectionType == SelectionType.Tab)
            UpdatePanelVisibility(index);

        // Handle selection actions
        ApplySelectionActions(items[index].id);

        if (fireEvents)
        {
            OnItemSelected?.Invoke(items[index].id);
            OnSelectionChanged?.Invoke(items[index].id, index);
            if (selectionType == SelectionType.Checkbox)
                OnMultiSelectionChanged?.Invoke(GetSelectedIds());
        }
    }

    public void SelectItemById(string itemId, bool fireEvents = true)
    {
        int index = FindItemIndex(itemId);
        if (index >= 0) SelectItem(index, fireEvents);
    }

    public void DeselectItem(int index, bool fireEvents = true)
    {
        if (index < 0 || index >= items.Count) return;
        if (!allowNone && selectedIndices.Count <= 1 && selectedIndices.Contains(index)) return;

        if (selectedIndices.Remove(index))
        {
            UpdateItemVisual(index, false);
            if (fireEvents)
            {
                OnItemDeselected?.Invoke(items[index].id);
                if (selectionType == SelectionType.Checkbox)
                    OnMultiSelectionChanged?.Invoke(GetSelectedIds());
            }
        }
    }

    public void ClearSelection()
    {
        var prev = new List<int>(selectedIndices);
        selectedIndices.Clear();
        foreach (var index in prev)
        {
            if (index < items.Count)
            {
                UpdateItemVisual(index, false);
                OnItemDeselected?.Invoke(items[index].id);
            }
        }
    }

    public List<string> GetSelectedIds()
    {
        var result = new List<string>();
        foreach (var index in selectedIndices)
        {
            if (index < items.Count)
                result.Add(items[index].id);
        }
        return result;
    }

    public string GetSelectedId()
    {
        foreach (var index in selectedIndices)
        {
            if (index < items.Count)
                return items[index].id;
        }
        return null;
    }

    public int GetSelectedIndex()
    {
        foreach (var index in selectedIndices)
            return index;
        return -1;
    }

    public int FindItemIndex(string itemId)
    {
        for (int i = 0; i < items.Count; i++)
        {
            if (items[i].id == itemId)
                return i;
        }
        return -1;
    }

    public void SetItemEnabled(int index, bool enabled)
    {
        if (index < 0 || index >= items.Count) return;
        items[index].enabled = enabled;

        if (index < itemInstances.Count && itemInstances[index] != null)
        {
            var btn = itemInstances[index].GetComponent<Button>();
            if (btn != null) btn.interactable = enabled;

            var img = itemInstances[index].GetComponent<Image>();
            if (img != null && !enabled) img.color = disabledColor;
        }
    }

    #endregion

    #region Internal

    private void RebuildUI()
    {
        ClearInstances();
        for (int i = 0; i < items.Count; i++)
            CreateItemInstance(i);
    }

    private void ClearInstances()
    {
        foreach (var inst in itemInstances)
        {
            if (inst != null) Destroy(inst);
        }
        itemInstances.Clear();
    }

    private void CreateItemInstance(int index)
    {
        if (itemPrefab == null || itemContainer == null) return;

        var instance = Instantiate(itemPrefab, itemContainer);
        instance.name = $"Item_{items[index].id ?? index.ToString()}";
        itemInstances.Add(instance);

        var item = items[index];

        var label = instance.GetComponentInChildren<Text>();
        if (label != null) label.text = item.label ?? "";

        var icon = instance.transform.Find("Icon")?.GetComponent<Image>();
        if (icon != null && item.icon != null) icon.sprite = item.icon;

        var btn = instance.GetComponent<Button>();
        if (btn == null) btn = instance.AddComponent<Button>();
        btn.interactable = item.enabled;

        int capturedIndex = index;
        btn.onClick.AddListener(() => SelectItem(capturedIndex));

        UpdateItemVisual(index, selectedIndices.Contains(index));
    }

    private void UpdateItemVisual(int index, bool selected)
    {
        if (index < 0 || index >= itemInstances.Count) return;
        var inst = itemInstances[index];
        if (inst == null) return;

        var img = inst.GetComponent<Image>();
        if (img != null)
            img.color = selected ? selectedColor : normalColor;
    }

    private void UpdatePanelVisibility(int selectedIndex)
    {
        for (int i = 0; i < items.Count; i++)
        {
            if (items[i].associatedPanel != null)
                items[i].associatedPanel.SetActive(i == selectedIndex);
        }
    }

    private void ApplySelectionActions(string selectedId)
    {
        foreach (var action in selectionActions)
        {
            if (action.selectedId != selectedId) continue;

            if (action.showPaths != null)
            {
                foreach (var path in action.showPaths)
                {
                    var go = GameObject.Find(path);
                    if (go != null) go.SetActive(true);
                }
            }
            if (action.hidePaths != null)
            {
                foreach (var path in action.hidePaths)
                {
                    var go = GameObject.Find(path);
                    if (go != null) go.SetActive(false);
                }
            }
        }
    }

    #endregion
}
