using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// Resource/economy manager with flows, converters, and trigger thresholds.
/// Generated by Unity-AI-Forge.
/// </summary>
public class {{CLASS_NAME}} : MonoBehaviour
{
    #region Types

    [System.Serializable]
    public class ResourceEntry
    {
        public string name;
        public float amount;
        public float minValue;
        public float maxValue = float.MaxValue;
    }

    [System.Serializable]
    public class ResourceFlow
    {
        public string flowId;
        public string resourceName;
        public float ratePerSecond;
        public bool isSource;
        public bool enabled = true;
    }

    [System.Serializable]
    public class ResourceConverter
    {
        public string converterId;
        public string fromResource;
        public string toResource;
        public float conversionRate = 1f;
        public float inputCost = 1f;
        public bool enabled = true;
    }

    [System.Serializable]
    public class ResourceTrigger
    {
        public string triggerName;
        public string resourceName;
        public ThresholdType thresholdType;
        public float thresholdValue;
        public bool enabled = true;
        [System.NonSerialized] public bool wasFired;
    }

    public enum ThresholdType
    {
        Above,
        Below,
        Equal,
        NotEqual
    }

    #endregion

    #region Settings

    [Header("Identity")]
    [SerializeField] private string managerId = "{{MANAGER_ID}}";

    [Header("Resources")]
    [SerializeField] private List<ResourceEntry> resources = new List<ResourceEntry>();

    [Header("Flows")]
    [SerializeField] private List<ResourceFlow> flows = new List<ResourceFlow>();

    [Header("Converters")]
    [SerializeField] private List<ResourceConverter> converters = new List<ResourceConverter>();

    [Header("Triggers")]
    [SerializeField] private List<ResourceTrigger> triggers = new List<ResourceTrigger>();

    [Header("Automation")]
    [SerializeField] private bool autoProcessFlows = {{AUTO_PROCESS_FLOWS}};
    [SerializeField] private bool autoCheckTriggers = {{AUTO_CHECK_TRIGGERS}};

    #endregion

    #region Events

    [Header("Events")]
    public UnityEvent<string, float> OnResourceChanged = new UnityEvent<string, float>();
    public UnityEvent<string, string, float> OnTriggerFired = new UnityEvent<string, string, float>();

    #endregion

    #region State

    private readonly Dictionary<string, ResourceEntry> resourceLookup = new Dictionary<string, ResourceEntry>();

    #endregion

    #region Registry

    private static readonly Dictionary<string, {{CLASS_NAME}}> _registry =
        new Dictionary<string, {{CLASS_NAME}}>();

    public static {{CLASS_NAME}} FindById(string id)
    {
        return _registry.TryGetValue(id, out var m) ? m : null;
    }

    #endregion

    #region Properties

    public string ManagerId => managerId;

    #endregion

    #region Lifecycle

    private void Awake()
    {
        foreach (var r in resources)
        {
            if (!string.IsNullOrEmpty(r.name))
                resourceLookup[r.name] = r;
        }
    }

    private void OnEnable()
    {
        if (!string.IsNullOrEmpty(managerId))
            _registry[managerId] = this;
    }

    private void OnDisable()
    {
        if (!string.IsNullOrEmpty(managerId))
            _registry.Remove(managerId);
    }

    private void Update()
    {
        if (autoProcessFlows)
            ProcessFlows(Time.deltaTime);
        if (autoCheckTriggers)
            CheckTriggers();
    }

    #endregion

    #region Resource API

    public float GetResource(string resourceName, float defaultValue = 0f)
    {
        return resourceLookup.TryGetValue(resourceName, out var r) ? r.amount : defaultValue;
    }

    public void SetResource(string resourceName, float amount)
    {
        if (!resourceLookup.TryGetValue(resourceName, out var r))
        {
            r = new ResourceEntry { name = resourceName, amount = 0, maxValue = float.MaxValue };
            resources.Add(r);
            resourceLookup[resourceName] = r;
        }
        r.amount = Mathf.Clamp(amount, r.minValue, r.maxValue);
        OnResourceChanged?.Invoke(resourceName, r.amount);
    }

    public void AddResource(string resourceName, float amount)
    {
        SetResource(resourceName, GetResource(resourceName) + amount);
    }

    public bool ConsumeResource(string resourceName, float amount)
    {
        float current = GetResource(resourceName);
        if (current < amount) return false;
        SetResource(resourceName, current - amount);
        return true;
    }

    public bool HasResource(string resourceName, float minAmount = 0)
    {
        return GetResource(resourceName) >= minAmount;
    }

    public Dictionary<string, float> GetAllResources()
    {
        var result = new Dictionary<string, float>();
        foreach (var r in resources)
            result[r.name] = r.amount;
        return result;
    }

    public void ClearAllResources()
    {
        foreach (var r in resources)
            r.amount = 0;
    }

    #endregion

    #region Flow API

    public void ProcessFlows(float deltaTime)
    {
        foreach (var flow in flows)
        {
            if (!flow.enabled) continue;
            float amount = flow.ratePerSecond * deltaTime;
            if (flow.isSource)
                AddResource(flow.resourceName, amount);
            else
                AddResource(flow.resourceName, -amount);
        }
    }

    public void SetFlowEnabled(string flowId, bool enabled)
    {
        var flow = flows.Find(f => f.flowId == flowId);
        if (flow != null) flow.enabled = enabled;
    }

    public bool IsFlowEnabled(string flowId)
    {
        var flow = flows.Find(f => f.flowId == flowId);
        return flow?.enabled ?? false;
    }

    #endregion

    #region Converter API

    public bool ExecuteConverter(string converterId, float amount = 1f)
    {
        var converter = converters.Find(c => c.converterId == converterId);
        if (converter == null || !converter.enabled) return false;

        float cost = converter.inputCost * amount;
        if (!HasResource(converter.fromResource, cost)) return false;

        ConsumeResource(converter.fromResource, cost);
        AddResource(converter.toResource, converter.conversionRate * amount);
        return true;
    }

    #endregion

    #region Trigger API

    public void CheckTriggers()
    {
        foreach (var trigger in triggers)
        {
            if (!trigger.enabled) continue;
            float value = GetResource(trigger.resourceName);
            bool shouldFire = false;

            switch (trigger.thresholdType)
            {
                case ThresholdType.Above:
                    shouldFire = value > trigger.thresholdValue;
                    break;
                case ThresholdType.Below:
                    shouldFire = value < trigger.thresholdValue;
                    break;
                case ThresholdType.Equal:
                    shouldFire = Mathf.Approximately(value, trigger.thresholdValue);
                    break;
                case ThresholdType.NotEqual:
                    shouldFire = !Mathf.Approximately(value, trigger.thresholdValue);
                    break;
            }

            if (shouldFire && !trigger.wasFired)
            {
                trigger.wasFired = true;
                OnTriggerFired?.Invoke(trigger.triggerName, trigger.resourceName, value);
            }
            else if (!shouldFire)
            {
                trigger.wasFired = false;
            }
        }
    }

    #endregion

    #region Save/Load

    public string ExportState()
    {
        var data = new Dictionary<string, float>();
        foreach (var r in resources)
            data[r.name] = r.amount;
        return JsonUtility.ToJson(new ResourceState { entries = new List<ResourceEntry>(resources) });
    }

    public void ImportState(string json)
    {
        if (string.IsNullOrEmpty(json)) return;
        var state = JsonUtility.FromJson<ResourceState>(json);
        foreach (var entry in state.entries)
            SetResource(entry.name, entry.amount);
    }

    [System.Serializable]
    private class ResourceState
    {
        public List<ResourceEntry> entries = new List<ResourceEntry>();
    }

    #endregion
}
